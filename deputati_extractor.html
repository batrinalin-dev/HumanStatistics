<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deputați România — Extractor CDEP</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0f14;
    --surface: #151921;
    --surface2: #1c2230;
    --border: #2a3042;
    --accent: #3b82f6;
    --accent-glow: #3b82f620;
    --green: #22c55e;
    --amber: #f59e0b;
    --red: #ef4444;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --text-faint: #64748b;
    --ro-blue: #002b7f;
    --ro-yellow: #fcd116;
    --ro-red: #ce1126;
  }
  * { margin: 0; padding: 0; box-sizing: border-box; }
  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.08;
    pointer-events: none;
    z-index: 0;
  }
  .app { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 2rem 1.5rem; }

  .header { text-align: center; margin-bottom: 2.5rem; animation: fadeDown 0.6s ease; }
  @keyframes fadeDown { from { opacity: 0; transform: translateY(-20px); } to { opacity: 1; transform: translateY(0); } }
  .flag-bar { display: flex; justify-content: center; gap: 0; margin-bottom: 1.5rem; }
  .flag-bar span { width: 40px; height: 6px; border-radius: 3px; }
  .flag-bar span:nth-child(1) { background: var(--ro-blue); }
  .flag-bar span:nth-child(2) { background: var(--ro-yellow); margin: 0 2px; }
  .flag-bar span:nth-child(3) { background: var(--ro-red); }
  .header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2.4rem;
    letter-spacing: -0.5px;
    margin-bottom: 0.4rem;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
  .header p { color: var(--text-dim); font-size: 0.95rem; }

  .input-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    animation: fadeUp 0.5s ease 0.1s both;
  }
  @keyframes fadeUp { from { opacity: 0; transform: translateY(15px); } to { opacity: 1; transform: translateY(0); } }
  .input-row { display: flex; gap: 0.75rem; align-items: stretch; }
  .input-row input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.85rem 1.1rem;
    color: var(--text);
    font-family: 'DM Sans', monospace;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-row input:focus { border-color: var(--accent); box-shadow: 0 0 0 3px var(--accent-glow); }
  .input-row input::placeholder { color: var(--text-faint); }

  .btn {
    display: inline-flex; align-items: center; gap: 0.5rem;
    padding: 0.85rem 1.4rem; border-radius: 10px; border: 1px solid transparent;
    font-family: 'DM Sans', sans-serif; font-size: 0.875rem; font-weight: 600;
    cursor: pointer; transition: all 0.2s; white-space: nowrap;
  }
  .btn-primary { background: var(--accent); color: #fff; border-color: var(--accent); }
  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 16px #3b82f640; }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }
  .btn-green { background: #16a34a; color: #fff; border-color: #16a34a; }
  .btn-green:hover { background: #15803d; }
  .btn-amber { background: #d97706; color: #fff; border-color: #d97706; }
  .btn-amber:hover { background: #b45309; }
  .btn svg { width: 16px; height: 16px; }

  .hint { margin-top: 0.75rem; font-size: 0.8rem; color: var(--text-faint); }
  .hint code { background: var(--surface2); padding: 2px 6px; border-radius: 4px; font-size: 0.78rem; color: var(--accent); }

  .status-bar { display: flex; justify-content: space-between; align-items: center; flex-wrap: wrap; gap: 1rem; margin-bottom: 1.25rem; animation: fadeUp 0.5s ease 0.2s both; }
  .status-left { display: flex; align-items: center; gap: 1rem; }
  .badge {
    display: inline-flex; align-items: center; gap: 0.4rem;
    padding: 0.4rem 0.85rem; border-radius: 20px; font-size: 0.8rem; font-weight: 600;
    background: var(--surface); border: 1px solid var(--border); color: var(--text-dim);
  }
  .badge .dot { width: 7px; height: 7px; border-radius: 50%; }
  .badge .dot.green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .export-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }

  .filter-bar { display: flex; gap: 0.75rem; margin-bottom: 1.25rem; flex-wrap: wrap; animation: fadeUp 0.5s ease 0.25s both; }
  .search-box { flex: 1; min-width: 200px; position: relative; }
  .search-box svg { position: absolute; left: 12px; top: 50%; transform: translateY(-50%); width: 16px; height: 16px; color: var(--text-faint); }
  .search-box input {
    width: 100%; background: var(--surface); border: 1px solid var(--border);
    border-radius: 10px; padding: 0.7rem 0.7rem 0.7rem 2.4rem;
    color: var(--text); font-size: 0.875rem; outline: none; transition: border-color 0.2s;
  }
  .search-box input:focus { border-color: var(--accent); }
  .filter-select {
    background: var(--surface); border: 1px solid var(--border); border-radius: 10px;
    padding: 0.7rem 1rem; color: var(--text); font-size: 0.875rem;
    outline: none; cursor: pointer; min-width: 180px;
  }
  .filter-select:focus { border-color: var(--accent); }

  .table-wrap {
    background: var(--surface); border: 1px solid var(--border);
    border-radius: 16px; overflow: hidden; animation: fadeUp 0.5s ease 0.3s both;
  }
  .table-scroll { overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; font-size: 0.875rem; }
  thead th {
    background: var(--surface2); padding: 0.85rem 1rem; text-align: left;
    font-weight: 600; font-size: 0.78rem; text-transform: uppercase;
    letter-spacing: 0.5px; color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    position: sticky; top: 0; cursor: pointer; user-select: none;
    transition: color 0.2s; white-space: nowrap;
  }
  thead th:hover { color: var(--accent); }
  thead th .sort-icon { margin-left: 4px; opacity: 0.4; }
  thead th.sorted .sort-icon { opacity: 1; color: var(--accent); }
  tbody tr { border-bottom: 1px solid var(--border); transition: background 0.15s; }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--surface2); }
  tbody td { padding: 0.75rem 1rem; color: var(--text); white-space: nowrap; }
  .idx { color: var(--text-faint); font-size: 0.78rem; font-weight: 500; width: 40px; }
  .name-cell { font-weight: 600; color: var(--text); }
  .name-cell a { color: inherit; text-decoration: none; transition: color 0.2s; }
  .name-cell a:hover { color: var(--accent); }

  .party-badge {
    display: inline-block; padding: 3px 10px; border-radius: 6px;
    font-size: 0.75rem; font-weight: 700; letter-spacing: 0.3px;
  }
  .party-PSD { background: #dc262620; color: #f87171; border: 1px solid #dc262630; }
  .party-PNL { background: #eab30820; color: #fbbf24; border: 1px solid #eab30830; }
  .party-USR { background: #06b6d420; color: #22d3ee; border: 1px solid #06b6d430; }
  .party-AUR { background: #a855f720; color: #c084fc; border: 1px solid #a855f730; }
  .party-UDMR { background: #22c55e20; color: #4ade80; border: 1px solid #22c55e30; }
  .party-SOS { background: #f4364c20; color: #fb7185; border: 1px solid #f4364c30; }
  .party-POT { background: #f97316; color: #fff; border: 1px solid #f9731630; background: #f9731620; color: #fb923c; }
  .party-MIN { background: #64748b20; color: #94a3b8; border: 1px solid #64748b30; }
  .party-NEA { background: #78716c20; color: #a8a29e; border: 1px solid #78716c30; }
  .party-default { background: #3b82f620; color: #60a5fa; border: 1px solid #3b82f630; }

  .region-cell { color: var(--text-dim); }
  .circ-cell { color: var(--text-faint); font-size: 0.82rem; }

  .loading { display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 4rem; color: var(--text-dim); gap: 1rem; }
  .spinner { width: 36px; height: 36px; border: 3px solid var(--border); border-top-color: var(--accent); border-radius: 50%; animation: spin 0.8s linear infinite; }
  @keyframes spin { to { transform: rotate(360deg); } }

  .empty-state { text-align: center; padding: 5rem 2rem; color: var(--text-faint); }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3; }
  .empty-state h3 { font-size: 1.1rem; color: var(--text-dim); margin-bottom: 0.5rem; }

  .error-box { background: #7f1d1d20; border: 1px solid #dc262640; border-radius: 12px; padding: 1.25rem; color: #fca5a5; margin-bottom: 1.5rem; }
  .error-box strong { color: #f87171; }

  .stats-row { display: flex; gap: 0.75rem; margin-bottom: 1.5rem; flex-wrap: wrap; animation: fadeUp 0.5s ease 0.15s both; }
  .stat-card {
    flex: 1; min-width: 110px; background: var(--surface);
    border: 1px solid var(--border); border-radius: 12px;
    padding: 1rem 1.2rem; text-align: center;
  }
  .stat-card .stat-num { font-family: 'DM Serif Display', serif; font-size: 1.6rem; color: var(--text); line-height: 1; margin-bottom: 0.25rem; }
  .stat-card .stat-label { font-size: 0.72rem; text-transform: uppercase; letter-spacing: 0.5px; color: var(--text-faint); font-weight: 600; }

  .footer { text-align: center; padding: 2rem 0 1rem; color: var(--text-faint); font-size: 0.78rem; }
  .footer a { color: var(--accent); }

  .pagination { display: flex; justify-content: center; align-items: center; gap: 0.5rem; padding: 1.25rem; border-top: 1px solid var(--border); }
  .page-btn {
    width: 36px; height: 36px; display: flex; align-items: center; justify-content: center;
    border-radius: 8px; border: 1px solid var(--border); background: transparent;
    color: var(--text-dim); cursor: pointer; font-size: 0.85rem; font-weight: 500; transition: all 0.2s;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-info { color: var(--text-faint); font-size: 0.8rem; margin: 0 0.5rem; }

  .progress-bar { width: 100%; height: 4px; background: var(--surface2); border-radius: 2px; margin-top: 0.75rem; overflow: hidden; }
  .progress-bar .fill { height: 100%; background: var(--accent); border-radius: 2px; transition: width 0.3s; width: 0%; }

  @media (max-width: 768px) {
    .header h1 { font-size: 1.6rem; }
    .input-row { flex-direction: column; }
    .stats-row { gap: 0.5rem; }
    .stat-card { min-width: 80px; padding: 0.75rem; }
    .stat-card .stat-num { font-size: 1.2rem; }
    .status-bar { flex-direction: column; align-items: flex-start; }
    .filter-bar { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="app" id="app">
  <div class="header">
    <div class="flag-bar"><span></span><span></span><span></span></div>
    <h1>Deputații României</h1>
    <p>Extractor date parlamentare — Camera Deputaților</p>
  </div>

  <div class="input-section">
    <div class="input-row">
      <input type="text" id="urlInput" placeholder="Introdu URL-ul cdep.ro..."
        value="https://www.cdep.ro/pls/parlam/structura2015.de?idl=1" />
      <button class="btn btn-primary" id="fetchBtn" onclick="fetchDeputies()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        Extrage date
      </button>
    </div>
    <p class="hint">Exemplu: <code>https://www.cdep.ro/pls/parlam/structura2015.de?idl=1</code></p>
    <div class="progress-bar" id="progressBar" style="display:none;"><div class="fill" id="progressFill"></div></div>
  </div>

  <div class="error-box" id="errorBox" style="display:none;"></div>

  <div class="stats-row" id="statsRow" style="display:none;">
    <div class="stat-card"><div class="stat-num" id="totalCount">0</div><div class="stat-label">Total Deputați</div></div>
    <div class="stat-card"><div class="stat-num" id="partyCount">0</div><div class="stat-label">Partide / Grupuri</div></div>
    <div class="stat-card"><div class="stat-num" id="regionCount">0</div><div class="stat-label">Regiuni (1-8)</div></div>
    <div class="stat-card"><div class="stat-num" id="circCount">0</div><div class="stat-label">Circumscripții</div></div>
  </div>

  <div class="status-bar" id="statusBar" style="display:none;">
    <div class="status-left">
      <div class="badge"><span class="dot green"></span><span id="statusText">Date încărcate</span></div>
    </div>
    <div class="export-btns">
      <button class="btn btn-green" onclick="exportExcel()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Export Excel
      </button>
      <button class="btn btn-amber" onclick="exportCSV()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
        Export CSV
      </button>
    </div>
  </div>

  <div class="filter-bar" id="filterBar" style="display:none;">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input type="text" id="searchInput" placeholder="Caută deputat..." oninput="applyFilters()" />
    </div>
    <select class="filter-select" id="partyFilter" onchange="applyFilters()"><option value="">Toate partidele</option></select>
    <select class="filter-select" id="regionFilter" onchange="applyFilters()"><option value="">Toate regiunile</option></select>
    <select class="filter-select" id="circFilter" onchange="applyFilters()"><option value="">Toate circumscripțiile</option></select>
  </div>

  <div class="table-wrap" id="tableWrap" style="display:none;">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('idx')"># <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('name')">Nume <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('party')">Grup parlamentar <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('regionCode')">Cod Regiune <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('circ')">Circumscripție <span class="sort-icon">↕</span></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

  <div class="loading" id="loadingState" style="display:none;">
    <div class="spinner"></div>
    <span id="loadingText">Se extrag datele de pe cdep.ro...</span>
  </div>

  <div class="empty-state" id="emptyState">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
    </svg>
    <h3>Introdu un link CDEP</h3>
    <p>Apasă „Extrage date" pentru a prelua lista de deputați</p>
  </div>

  <div class="footer" id="footer" style="display:none;">
    Sursă date: <a href="https://www.cdep.ro" target="_blank">cdep.ro</a> — Camera Deputaților a Parlamentului României
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  let allDeputies = [];
  let filteredDeputies = [];
  let currentSort = { key: 'idx', asc: true };
  let currentPage = 1;
  const perPage = 50;

  // ============================================================
  // REGIUNI DE DEZVOLTARE (NUTS 2) — codare 1-8, 99=fără date
  // ============================================================
  const REGION_NAMES = {
    1: '1 – Nord-Est',
    2: '2 – Sud-Est',
    3: '3 – Sud Muntenia',
    4: '4 – Sud-Vest Oltenia',
    5: '5 – Vest',
    6: '6 – Nord-Vest',
    7: '7 – Centru',
    8: '8 – București-Ilfov',
    99: '99 – Fără date',
  };

  // Județ → cod regiune
  const COUNTY_TO_REGION = {
    // 1 – Nord-Est
    'iași': 1, 'iasi': 1, 'botoșani': 1, 'botosani': 1, 'neamț': 1, 'neamt': 1,
    'suceava': 1, 'bacău': 1, 'bacau': 1, 'vaslui': 1,
    // 2 – Sud-Est
    'vrancea': 2, 'galați': 2, 'galati': 2, 'brăila': 2, 'braila': 2,
    'tulcea': 2, 'buzău': 2, 'buzau': 2, 'constanța': 2, 'constanta': 2,
    // 3 – Sud Muntenia
    'argeș': 3, 'arges': 3, 'dâmbovița': 3, 'dambovita': 3, 'prahova': 3,
    'ialomița': 3, 'ialomita': 3, 'călărași': 3, 'calarasi': 3,
    'giurgiu': 3, 'teleorman': 3,
    // 4 – Sud-Vest Oltenia
    'mehedinți': 4, 'mehedinti': 4, 'gorj': 4, 'vâlcea': 4, 'valcea': 4,
    'olt': 4, 'dolj': 4,
    // 5 – Vest
    'arad': 5, 'caraș-severin': 5, 'caras-severin': 5, 'hunedoara': 5,
    'timiș': 5, 'timis': 5,
    // 6 – Nord-Vest
    'bihor': 6, 'bistrița-năsăud': 6, 'bistrita-nasaud': 6,
    'cluj': 6, 'maramureș': 6, 'maramures': 6,
    'satu mare': 6, 'sălaj': 6, 'salaj': 6,
    // 7 – Centru
    'alba': 7, 'sibiu': 7, 'mureș': 7, 'mures': 7,
    'harghita': 7, 'covasna': 7, 'brașov': 7, 'brasov': 7,
    // 8 – București-Ilfov
    'bucurești': 8, 'bucuresti': 8, 'ilfov': 8,
  };

  // Circumscripție electorală (nr) → județ
  const CIRC_TO_COUNTY = {
    '1': 'alba', '2': 'arad', '3': 'argeș', '4': 'bacău',
    '5': 'bihor', '6': 'bistrița-năsăud', '7': 'botoșani', '8': 'brașov',
    '9': 'brăila', '10': 'buzău', '11': 'caraș-severin', '12': 'cluj',
    '13': 'constanța', '14': 'covasna', '15': 'dâmbovița', '16': 'dolj',
    '17': 'galați', '18': 'gorj', '19': 'harghita', '20': 'hunedoara',
    '21': 'ialomița', '22': 'iași', '23': 'ilfov', '24': 'maramureș',
    '25': 'mehedinți', '26': 'mureș', '27': 'neamț', '28': 'olt',
    '29': 'prahova', '30': 'satu mare', '31': 'sălaj', '32': 'sibiu',
    '33': 'suceava', '34': 'teleorman', '35': 'timiș', '36': 'tulcea',
    '37': 'vaslui', '38': 'vâlcea', '39': 'vrancea',
    '40': 'bucurești', '41': 'bucurești', '42': 'diaspora', '43': 'diaspora',
  };

  // List of all county names (with and without diacritics) for text matching
  const COUNTIES = [
    'Alba', 'Arad', 'Argeș', 'Arges', 'Bacău', 'Bacau', 'Bihor',
    'Bistrița-Năsăud', 'Bistrita-Nasaud', 'Botoșani', 'Botosani',
    'Brașov', 'Brasov', 'Brăila', 'Braila', 'Buzău', 'Buzau',
    'Caraș-Severin', 'Caras-Severin', 'Cluj', 'Constanța', 'Constanta',
    'Covasna', 'Dâmbovița', 'Dambovita', 'Dolj', 'Galați', 'Galati',
    'Gorj', 'Harghita', 'Hunedoara', 'Ialomița', 'Ialomita',
    'Iași', 'Iasi', 'Ilfov', 'Maramureș', 'Maramures',
    'Mehedinți', 'Mehedinti', 'Mureș', 'Mures', 'Neamț', 'Neamt',
    'Olt', 'Prahova', 'Satu Mare', 'Sălaj', 'Salaj', 'Sibiu',
    'Suceava', 'Teleorman', 'Timiș', 'Timis', 'Tulcea',
    'Vaslui', 'Vâlcea', 'Valcea', 'Vrancea', 'București', 'Bucuresti',
    'Călărași', 'Calarasi', 'Giurgiu', 'Diaspora'
  ];

  // Resolve a county name (or circ number) to a region code (1-8 or 99)
  function getRegionCode(countyOrCirc) {
    if (!countyOrCirc) return 99;
    // Try as county name
    const lower = countyOrCirc.toString().toLowerCase().trim();
    if (COUNTY_TO_REGION[lower] !== undefined) return COUNTY_TO_REGION[lower];
    // Try as circ number
    const county = CIRC_TO_COUNTY[lower];
    if (county) {
      if (county === 'diaspora') return 99;
      if (COUNTY_TO_REGION[county] !== undefined) return COUNTY_TO_REGION[county];
    }
    // Try partial match on county names
    for (const [key, code] of Object.entries(COUNTY_TO_REGION)) {
      if (lower.includes(key) || key.includes(lower)) return code;
    }
    return 99;
  }

  function getRegionLabel(code) {
    return REGION_NAMES[code] || REGION_NAMES[99];
  }

  // ============================================================
  // DIACRITICS FIX: Map Windows-1250/ISO-8859-2 mojibake to proper Romanian
  // ============================================================
  function fixDiacritics(text) {
    if (!text) return text;
    // Common mojibake patterns when Windows-1250 / ISO-8859-2 is read as ISO-8859-1 or Latin-1
    const replacements = [
      // ș (s-comma-below)
      [/\u0219/g, 'ș'], // already correct
      [/ş/g, 'ș'],      // s-cedilla → s-comma
      [/º/g, 'ș'],
      [/\u00BA/g, 'ș'],
      // ț (t-comma-below)
      [/\u021B/g, 'ț'], // already correct
      [/ţ/g, 'ț'],      // t-cedilla → t-comma
      [/þ/g, 'ț'],
      [/\u00FE/g, 'ț'],
      // ă
      [/\u0103/g, 'ă'], // already correct
      [/ã/g, 'ă'],
      [/\u00E3/g, 'ă'],
      // â
      [/\u00E2/g, 'â'], // already correct
      // î
      [/\u00EE/g, 'î'], // already correct
      // Uppercase variants
      [/Ş/g, 'Ș'],
      [/Ţ/g, 'Ț'],
      [/\u0102/g, 'Ă'],
      [/Ã/g, 'Ă'],
      [/\u00C2/g, 'Â'],
      [/\u00CE/g, 'Î'],
      // Common double-mojibake (UTF-8 read as Windows-1252)
      [/Ä\u0083/g, 'ă'],
      [/Ã¢/g, 'â'],
      [/Ã®/g, 'î'],
      [/È\u0099/g, 'ș'],
      [/È›/g, 'ț'],
      [/È\u009B/g, 'ț'],
      [/È™/g, 'ș'],
      [/Ä‚/g, 'Ă'],
      [/Ãž/g, 'Ț'],
      [/Ãª/g, 'ê'],
      // Numeric entities sometimes left over
      [/&#x21[bB];/g, 'ț'],
      [/&#x219;/g, 'ș'],
      [/&#x103;/g, 'ă'],
      [/&#xe2;/g, 'â'],
      [/&#xee;/g, 'î'],
      [/&#259;/g, 'ă'],
      [/&#226;/g, 'â'],
      [/&#238;/g, 'î'],
      [/&#537;/g, 'ș'],
      [/&#539;/g, 'ț'],
      [/&#350;/g, 'Ș'],
      [/&#354;/g, 'Ț'],
    ];
    let result = text;
    for (const [pattern, replacement] of replacements) {
      result = result.replace(pattern, replacement);
    }
    return result;
  }

  // ============================================================
  // CORS PROXIES
  // ============================================================
  const CORS_PROXIES = [
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  ];

  async function fetchWithProxy(url) {
    for (let i = 0; i < CORS_PROXIES.length; i++) {
      try {
        updateProgress(((i + 1) / CORS_PROXIES.length) * 30);
        const proxyUrl = CORS_PROXIES[i](url);
        const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
        if (resp.ok) {
          // Try to get the response as ArrayBuffer to handle encoding
          const buffer = await resp.arrayBuffer();
          // Try UTF-8 first
          let text = new TextDecoder('utf-8').decode(buffer);
          // If it looks garbled, try windows-1250
          if (text.includes('Ã') && text.includes('Å') || text.includes('\ufffd')) {
            text = new TextDecoder('windows-1250').decode(buffer);
          }
          // Also try iso-8859-2 if still garbled
          if (text.includes('\ufffd')) {
            text = new TextDecoder('iso-8859-2').decode(buffer);
          }
          if (text.length > 500) return text;
        }
      } catch (e) {
        console.warn(`Proxy ${i} failed:`, e.message);
      }
    }
    throw new Error('Toate proxy-urile CORS au eșuat. Verifică conexiunea la internet sau încearcă mai târziu.');
  }

  // ============================================================
  // PARSE LOGIC — handles cdep.ro deputy list pages
  // ============================================================
  function parseDeputies(html) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const deputies = [];

    // Strategy: find all links pointing to individual deputy pages (.mp?)
    const allLinks = doc.querySelectorAll('a');
    const deputyLinks = [];

    allLinks.forEach(a => {
      const href = a.getAttribute('href') || '';
      const text = a.textContent.trim();
      // Deputy links contain structura2015.mp or just .mp? with an id
      if ((href.includes('.mp?') || href.includes('structura2015.mp')) && text.length > 3) {
        deputyLinks.push({ element: a, href, text });
      }
    });

    for (const dl of deputyLinks) {
      const a = dl.element;
      let name = fixDiacritics(dl.text);

      // Navigate up to find the row (could be <tr> or parent container)
      const row = a.closest('tr') || a.closest('div') || a.parentElement?.parentElement;
      if (!row) continue;

      // Get all text cells in the row
      const cells = row.querySelectorAll('td');
      let party = '', circ = '', countyFound = '';

      if (cells.length >= 2) {
        // Typical cdep.ro structure: Name | Party | Circ/Region info
        const cellTexts = Array.from(cells).map(td => fixDiacritics(td.textContent.trim()));

        // Find which cell contains the name
        let nameIdx = -1;
        for (let i = 0; i < cellTexts.length; i++) {
          if (cellTexts[i].includes(name.substring(0, 5)) || cells[i].contains(a)) {
            nameIdx = i;
            break;
          }
        }

        // Extract party & circ from remaining cells
        for (let i = 0; i < cellTexts.length; i++) {
          if (i === nameIdx) continue;
          const ct = cellTexts[i];

          // Check if it's a party identifier
          if (!party && isPartyText(ct)) {
            party = normalizeParty(ct);
          }
          // Check if it's a circumscripție
          else if (!circ && /\d/.test(ct)) {
            circ = ct;
          }
          // Might contain county info
          else if (!countyFound && isRegionText(ct)) {
            countyFound = extractCountyName(ct);
          }
        }

        // If no county found, try to extract from circ text
        if (!countyFound && circ) {
          countyFound = extractCountyName(circ);
        }

        // Try to get circumscription number and look up county
        if (!countyFound) {
          const circNum = extractCircNumber(circ || dl.href);
          if (circNum && CIRC_TO_COUNTY[circNum]) {
            countyFound = CIRC_TO_COUNTY[circNum];
          }
        }

        // Also try extracting from the href (has circ number)
        if (!countyFound) {
          const hrefMatch = dl.href.match(/cam=(\d+)|cir=(\d+)/);
          if (hrefMatch) {
            const num = hrefMatch[1] || hrefMatch[2];
            if (CIRC_TO_COUNTY[num]) countyFound = CIRC_TO_COUNTY[num];
          }
        }
      } else {
        // Fallback: parse from parent text
        const parentText = fixDiacritics(row.textContent || '');
        party = extractPartyFromText(parentText);
        circ = extractCircFromText(parentText);
        countyFound = extractCountyName(parentText);
      }

      // Resolve county → region code (1-8 or 99)
      const regionCode = getRegionCode(countyFound);

      deputies.push({
        name: name,
        party: party || '',
        regionCode: regionCode,
        region: getRegionLabel(regionCode),
        circ: fixDiacritics(circ || ''),
        link: dl.href
      });
    }

    // Deduplicate by name
    const seen = new Set();
    return deputies.filter(d => {
      if (seen.has(d.name)) return false;
      seen.add(d.name);
      return true;
    });
  }

  function isPartyText(text) {
    const parties = ['PSD', 'PNL', 'USR', 'AUR', 'UDMR', 'SOS', 'POT', 'neafiliat', 'minorit', 'Grupul'];
    const lower = text.toLowerCase();
    return parties.some(p => lower.includes(p.toLowerCase()));
  }

  function normalizeParty(text) {
    const t = text.toUpperCase();
    if (t.includes('PSD')) return 'PSD';
    if (t.includes('PNL')) return 'PNL';
    if (t.includes('USR')) return 'USR';
    if (t.includes('AUR')) return 'AUR';
    if (t.includes('UDMR')) return 'UDMR';
    if (t.includes('SOS')) return 'SOS România';
    if (t.includes('POT')) return 'POT';
    if (text.toLowerCase().includes('minorit')) return 'Minorități';
    if (text.toLowerCase().includes('neafiliat')) return 'Neafiliat';
    return text.trim();
  }

  function isRegionText(text) {
    return COUNTIES.some(c => text.toLowerCase().includes(c.toLowerCase()));
  }

  function extractCountyName(text) {
    if (!text) return '';
    const lower = text.toLowerCase();
    // Try to find a county name in the text
    for (const county of COUNTIES) {
      if (lower.includes(county.toLowerCase())) {
        return county.toLowerCase();
      }
    }
    return '';
  }

  function extractCircNumber(text) {
    if (!text) return '';
    const match = text.match(/(?:Nr\.?\s*|cir=|#)\s*(\d+)/i) || text.match(/(\d+)/);
    return match ? match[1] : '';
  }

  function extractPartyFromText(text) {
    if (!text) return '';
    if (isPartyText(text)) return normalizeParty(text);
    return '';
  }

  function extractCircFromText(text) {
    const match = text.match(/Nr\.?\s*\d+[^\n]*/i);
    return match ? match[0].trim() : '';
  }

  function getPartyClass(party) {
    if (!party) return 'party-default';
    const p = party.toUpperCase();
    if (p.includes('PSD')) return 'party-PSD';
    if (p.includes('PNL')) return 'party-PNL';
    if (p.includes('USR')) return 'party-USR';
    if (p.includes('AUR')) return 'party-AUR';
    if (p.includes('UDMR')) return 'party-UDMR';
    if (p.includes('SOS')) return 'party-SOS';
    if (p.includes('POT')) return 'party-POT';
    if (p.includes('MINOR')) return 'party-MIN';
    if (p.includes('NEAFIL')) return 'party-NEA';
    return 'party-default';
  }

  // ============================================================
  // UI & FETCH
  // ============================================================
  function updateProgress(pct) {
    const bar = document.getElementById('progressBar');
    const fill = document.getElementById('progressFill');
    bar.style.display = 'block';
    fill.style.width = Math.min(pct, 100) + '%';
  }

  async function fetchDeputies() {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return;

    showLoading(true);
    hideError();
    updateProgress(5);

    try {
      document.getElementById('loadingText').textContent = 'Se conectează la cdep.ro...';
      const html = await fetchWithProxy(url);
      updateProgress(50);

      document.getElementById('loadingText').textContent = 'Se parsează datele...';
      allDeputies = parseDeputies(html);
      updateProgress(80);

      if (allDeputies.length === 0) {
        showError('Nu s-au putut extrage deputați din pagina dată. Verifică URL-ul sau structura paginii. Pagina trebuie să fie o listă de deputați de pe cdep.ro.');
        showLoading(false);
        document.getElementById('progressBar').style.display = 'none';
        return;
      }

      allDeputies.forEach((d, i) => d.idx = i + 1);
      updateProgress(90);

      populateFilters();
      applyFilters();
      updateStats();
      updateProgress(100);

      document.getElementById('statsRow').style.display = 'flex';
      document.getElementById('statusBar').style.display = 'flex';
      document.getElementById('filterBar').style.display = 'flex';
      document.getElementById('tableWrap').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('footer').style.display = 'block';

      setTimeout(() => { document.getElementById('progressBar').style.display = 'none'; }, 500);
    } catch (err) {
      showError(`Eroare la extragerea datelor: ${err.message}`);
      document.getElementById('progressBar').style.display = 'none';
    }
    showLoading(false);
  }

  function populateFilters() {
    const partySet = new Set(allDeputies.map(d => d.party).filter(Boolean));
    // Regions: collect unique region codes, sort numerically
    const regionCodes = [...new Set(allDeputies.map(d => d.regionCode))].sort((a, b) => a - b);
    const circSet = new Set(allDeputies.map(d => d.circ).filter(Boolean));

    const partySelect = document.getElementById('partyFilter');
    partySelect.innerHTML = '<option value="">Toate partidele</option>';
    [...partySet].sort().forEach(p => {
      const count = allDeputies.filter(d => d.party === p).length;
      partySelect.innerHTML += `<option value="${esc(p)}">${esc(p)} (${count})</option>`;
    });

    const regionSelect = document.getElementById('regionFilter');
    regionSelect.innerHTML = '<option value="">Toate regiunile</option>';
    regionCodes.forEach(code => {
      const label = getRegionLabel(code);
      const count = allDeputies.filter(d => d.regionCode === code).length;
      regionSelect.innerHTML += `<option value="${code}">${esc(label)} (${count})</option>`;
    });

    const circSelect = document.getElementById('circFilter');
    circSelect.innerHTML = '<option value="">Toate circumscripțiile</option>';
    [...circSet].sort().forEach(c => {
      circSelect.innerHTML += `<option value="${esc(c)}">${esc(c)}</option>`;
    });
  }

  function esc(s) { return s.replace(/&/g,'&amp;').replace(/"/g,'&quot;').replace(/</g,'&lt;'); }

  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const party = document.getElementById('partyFilter').value;
    const region = document.getElementById('regionFilter').value;
    const circ = document.getElementById('circFilter').value;

    filteredDeputies = allDeputies.filter(d => {
      if (search && !d.name.toLowerCase().includes(search) && !d.party.toLowerCase().includes(search) && !d.region.toLowerCase().includes(search)) return false;
      if (party && d.party !== party) return false;
      if (region && d.regionCode !== parseInt(region)) return false;
      if (circ && d.circ !== circ) return false;
      return true;
    });

    sortData();
    currentPage = 1;
    renderTable();
    document.getElementById('statusText').textContent = `${filteredDeputies.length} din ${allDeputies.length} deputați`;
  }

  function sortBy(key) {
    if (currentSort.key === key) currentSort.asc = !currentSort.asc;
    else { currentSort.key = key; currentSort.asc = true; }
    sortData();
    renderTable();
  }

  function sortData() {
    const { key, asc } = currentSort;
    filteredDeputies.sort((a, b) => {
      let va = a[key] || '', vb = b[key] || '';
      if (key === 'idx' || key === 'regionCode') { va = +va; vb = +vb; }
      else { va = va.toString().toLowerCase(); vb = vb.toString().toLowerCase(); }
      if (va < vb) return asc ? -1 : 1;
      if (va > vb) return asc ? 1 : -1;
      return 0;
    });
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    const totalPages = Math.ceil(filteredDeputies.length / perPage);
    const start = (currentPage - 1) * perPage;
    const pageData = filteredDeputies.slice(start, start + perPage);

    tbody.innerHTML = pageData.map(d => {
      const fullLink = d.link.startsWith('http') ? d.link : `https://www.cdep.ro/pls/parlam/${d.link}`;
      return `<tr>
        <td class="idx">${d.idx}</td>
        <td class="name-cell"><a href="${esc(fullLink)}" target="_blank" rel="noopener">${esc(d.name)}</a></td>
        <td><span class="party-badge ${getPartyClass(d.party)}">${esc(d.party || '-')}</span></td>
        <td class="region-cell"><strong>${d.regionCode}</strong> <span style="color:var(--text-faint);font-size:0.78rem">${esc(d.region.replace(/^\d+\s*–\s*/, ''))}</span></td>
        <td class="circ-cell">${esc(d.circ || '-')}</td>
      </tr>`;
    }).join('');

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    const pag = document.getElementById('pagination');
    if (totalPages <= 1) { pag.innerHTML = ''; return; }
    let html = `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;
    const range = 2;
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - range && i <= currentPage + range)) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
      } else if (i === currentPage - range - 1 || i === currentPage + range + 1) {
        html += `<span class="page-info">…</span>`;
      }
    }
    html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
    pag.innerHTML = html;
  }

  function goPage(p) {
    const totalPages = Math.ceil(filteredDeputies.length / perPage);
    if (p < 1 || p > totalPages) return;
    currentPage = p;
    renderTable();
    document.getElementById('tableWrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function updateStats() {
    document.getElementById('totalCount').textContent = allDeputies.length;
    document.getElementById('partyCount').textContent = new Set(allDeputies.map(d => d.party).filter(Boolean)).size;
    document.getElementById('regionCount').textContent = new Set(allDeputies.map(d => d.regionCode).filter(c => c !== 99)).size;
    document.getElementById('circCount').textContent = new Set(allDeputies.map(d => d.circ).filter(Boolean)).size;
  }

  // ============================================================
  // EXPORT
  // ============================================================
  function exportExcel() {
    if (filteredDeputies.length === 0) return;
    const data = filteredDeputies.map(d => ({
      'Nr.': d.idx,
      'Nume': d.name,
      'Grup Parlamentar': d.party,
      'Cod Regiune': d.regionCode,
      'Regiune': d.region,
      'Circumscripție': d.circ
    }));
    const ws = XLSX.utils.json_to_sheet(data);
    ws['!cols'] = [{ wch: 5 }, { wch: 35 }, { wch: 20 }, { wch: 12 }, { wch: 22 }, { wch: 25 }];
    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Deputați');
    XLSX.writeFile(wb, 'deputati_romania.xlsx');
  }

  function exportCSV() {
    if (filteredDeputies.length === 0) return;
    const BOM = '\uFEFF';
    const header = 'Nr.,Nume,Grup Parlamentar,Cod Regiune,Regiune,Circumscripție\n';
    const rows = filteredDeputies.map(d =>
      `${d.idx},"${(d.name||'').replace(/"/g,'""')}","${(d.party||'').replace(/"/g,'""')}",${d.regionCode},"${(d.region||'').replace(/"/g,'""')}","${(d.circ||'').replace(/"/g,'""')}"`
    ).join('\n');
    const blob = new Blob([BOM + header + rows], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'deputati_romania.csv';
    link.click();
    URL.revokeObjectURL(link.href);
  }

  // ============================================================
  // UI HELPERS
  // ============================================================
  function showLoading(show) {
    document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
    document.getElementById('fetchBtn').disabled = show;
    if (show) document.getElementById('emptyState').style.display = 'none';
  }

  function showError(msg) {
    const box = document.getElementById('errorBox');
    box.innerHTML = `<strong>⚠ Eroare:</strong> ${msg}`;
    box.style.display = 'block';
  }

  function hideError() { document.getElementById('errorBox').style.display = 'none'; }

  document.getElementById('urlInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') fetchDeputies();
  });
</script>
</body>
</html>
