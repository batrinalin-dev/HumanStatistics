<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Deputați România — Extractor CDEP</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Serif+Display&family=DM+Sans:wght@400;500;600;700&display=swap" rel="stylesheet">
<style>
  :root {
    --bg: #0c0f14;
    --surface: #151921;
    --surface2: #1c2230;
    --border: #2a3042;
    --accent: #3b82f6;
    --accent-glow: #3b82f620;
    --green: #22c55e;
    --amber: #f59e0b;
    --red: #ef4444;
    --text: #e2e8f0;
    --text-dim: #94a3b8;
    --text-faint: #64748b;
    --ro-blue: #002b7f;
    --ro-yellow: #fcd116;
    --ro-red: #ce1126;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  body {
    font-family: 'DM Sans', sans-serif;
    background: var(--bg);
    color: var(--text);
    min-height: 100vh;
    overflow-x: hidden;
  }

  /* Subtle grid background */
  body::before {
    content: '';
    position: fixed;
    inset: 0;
    background-image:
      linear-gradient(var(--border) 1px, transparent 1px),
      linear-gradient(90deg, var(--border) 1px, transparent 1px);
    background-size: 60px 60px;
    opacity: 0.08;
    pointer-events: none;
    z-index: 0;
  }

  .app { position: relative; z-index: 1; max-width: 1400px; margin: 0 auto; padding: 2rem 1.5rem; }

  /* Header */
  .header {
    text-align: center;
    margin-bottom: 2.5rem;
    animation: fadeDown 0.6s ease;
  }

  @keyframes fadeDown {
    from { opacity: 0; transform: translateY(-20px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .flag-bar {
    display: flex;
    justify-content: center;
    gap: 0;
    margin-bottom: 1.5rem;
  }
  .flag-bar span {
    width: 40px; height: 6px; border-radius: 3px;
  }
  .flag-bar span:nth-child(1) { background: var(--ro-blue); }
  .flag-bar span:nth-child(2) { background: var(--ro-yellow); margin: 0 2px; }
  .flag-bar span:nth-child(3) { background: var(--ro-red); }

  .header h1 {
    font-family: 'DM Serif Display', serif;
    font-size: 2.4rem;
    letter-spacing: -0.5px;
    margin-bottom: 0.4rem;
    background: linear-gradient(135deg, var(--text) 0%, var(--accent) 100%);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }

  .header p {
    color: var(--text-dim);
    font-size: 0.95rem;
  }

  /* Input section */
  .input-section {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    padding: 1.5rem;
    margin-bottom: 2rem;
    animation: fadeUp 0.5s ease 0.1s both;
  }

  @keyframes fadeUp {
    from { opacity: 0; transform: translateY(15px); }
    to { opacity: 1; transform: translateY(0); }
  }

  .input-row {
    display: flex;
    gap: 0.75rem;
    align-items: stretch;
  }

  .input-row input {
    flex: 1;
    background: var(--surface2);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.85rem 1.1rem;
    color: var(--text);
    font-family: 'DM Sans', monospace;
    font-size: 0.9rem;
    outline: none;
    transition: border-color 0.2s, box-shadow 0.2s;
  }
  .input-row input:focus {
    border-color: var(--accent);
    box-shadow: 0 0 0 3px var(--accent-glow);
  }
  .input-row input::placeholder { color: var(--text-faint); }

  .btn {
    display: inline-flex;
    align-items: center;
    gap: 0.5rem;
    padding: 0.85rem 1.4rem;
    border-radius: 10px;
    border: 1px solid transparent;
    font-family: 'DM Sans', sans-serif;
    font-size: 0.875rem;
    font-weight: 600;
    cursor: pointer;
    transition: all 0.2s;
    white-space: nowrap;
  }

  .btn-primary {
    background: var(--accent);
    color: #fff;
    border-color: var(--accent);
  }
  .btn-primary:hover { background: #2563eb; transform: translateY(-1px); box-shadow: 0 4px 16px #3b82f640; }
  .btn-primary:active { transform: translateY(0); }
  .btn-primary:disabled { opacity: 0.5; cursor: not-allowed; transform: none; }

  .btn-outline {
    background: transparent;
    color: var(--text-dim);
    border-color: var(--border);
  }
  .btn-outline:hover { border-color: var(--text-dim); color: var(--text); background: var(--surface2); }

  .btn-green { background: #16a34a; color: #fff; border-color: #16a34a; }
  .btn-green:hover { background: #15803d; }

  .btn-amber { background: #d97706; color: #fff; border-color: #d97706; }
  .btn-amber:hover { background: #b45309; }

  .btn svg { width: 16px; height: 16px; }

  .hint {
    margin-top: 0.75rem;
    font-size: 0.8rem;
    color: var(--text-faint);
  }
  .hint code {
    background: var(--surface2);
    padding: 2px 6px;
    border-radius: 4px;
    font-size: 0.78rem;
    color: var(--accent);
  }

  /* Status bar */
  .status-bar {
    display: flex;
    justify-content: space-between;
    align-items: center;
    flex-wrap: wrap;
    gap: 1rem;
    margin-bottom: 1.25rem;
    animation: fadeUp 0.5s ease 0.2s both;
  }

  .status-left {
    display: flex;
    align-items: center;
    gap: 1rem;
  }

  .badge {
    display: inline-flex;
    align-items: center;
    gap: 0.4rem;
    padding: 0.4rem 0.85rem;
    border-radius: 20px;
    font-size: 0.8rem;
    font-weight: 600;
    background: var(--surface);
    border: 1px solid var(--border);
    color: var(--text-dim);
  }
  .badge .dot { width: 7px; height: 7px; border-radius: 50%; }
  .badge .dot.green { background: var(--green); box-shadow: 0 0 6px var(--green); }
  .badge .dot.amber { background: var(--amber); }
  .badge .dot.red { background: var(--red); }

  .export-btns { display: flex; gap: 0.5rem; flex-wrap: wrap; }

  /* Search & filter */
  .filter-bar {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.25rem;
    flex-wrap: wrap;
    animation: fadeUp 0.5s ease 0.25s both;
  }

  .search-box {
    flex: 1;
    min-width: 200px;
    position: relative;
  }
  .search-box svg {
    position: absolute;
    left: 12px;
    top: 50%;
    transform: translateY(-50%);
    width: 16px; height: 16px;
    color: var(--text-faint);
  }
  .search-box input {
    width: 100%;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 0.7rem 0.7rem 2.4rem;
    color: var(--text);
    font-size: 0.875rem;
    outline: none;
    transition: border-color 0.2s;
  }
  .search-box input:focus { border-color: var(--accent); }

  .filter-select {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 10px;
    padding: 0.7rem 1rem;
    color: var(--text);
    font-size: 0.875rem;
    outline: none;
    cursor: pointer;
    min-width: 180px;
  }
  .filter-select:focus { border-color: var(--accent); }

  /* Table */
  .table-wrap {
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 16px;
    overflow: hidden;
    animation: fadeUp 0.5s ease 0.3s both;
  }

  .table-scroll { overflow-x: auto; }

  table {
    width: 100%;
    border-collapse: collapse;
    font-size: 0.875rem;
  }

  thead th {
    background: var(--surface2);
    padding: 0.85rem 1rem;
    text-align: left;
    font-weight: 600;
    font-size: 0.78rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-dim);
    border-bottom: 1px solid var(--border);
    position: sticky;
    top: 0;
    cursor: pointer;
    user-select: none;
    transition: color 0.2s;
    white-space: nowrap;
  }
  thead th:hover { color: var(--accent); }
  thead th .sort-icon { margin-left: 4px; opacity: 0.4; }
  thead th.sorted .sort-icon { opacity: 1; color: var(--accent); }

  tbody tr {
    border-bottom: 1px solid var(--border);
    transition: background 0.15s;
  }
  tbody tr:last-child { border-bottom: none; }
  tbody tr:hover { background: var(--surface2); }

  tbody td {
    padding: 0.75rem 1rem;
    color: var(--text);
    white-space: nowrap;
  }

  .idx { color: var(--text-faint); font-size: 0.78rem; font-weight: 500; width: 40px; }

  .name-cell {
    font-weight: 600;
    color: var(--text);
  }
  .name-cell a {
    color: inherit;
    text-decoration: none;
    transition: color 0.2s;
  }
  .name-cell a:hover { color: var(--accent); }

  .party-badge {
    display: inline-block;
    padding: 3px 10px;
    border-radius: 6px;
    font-size: 0.75rem;
    font-weight: 700;
    letter-spacing: 0.3px;
  }

  .party-PSD { background: #dc262620; color: #f87171; border: 1px solid #dc262630; }
  .party-PNL { background: #eab30820; color: #fbbf24; border: 1px solid #eab30830; }
  .party-USR { background: #06b6d420; color: #22d3ee; border: 1px solid #06b6d430; }
  .party-AUR { background: #a855f720; color: #c084fc; border: 1px solid #a855f730; }
  .party-UDMR { background: #22c55e20; color: #4ade80; border: 1px solid #22c55e30; }
  .party-MIN { background: #64748b20; color: #94a3b8; border: 1px solid #64748b30; }
  .party-NEA { background: #78716c20; color: #a8a29e; border: 1px solid #78716c30; }
  .party-default { background: #3b82f620; color: #60a5fa; border: 1px solid #3b82f630; }

  .circ { color: var(--text-dim); }

  /* Loading */
  .loading {
    display: flex;
    flex-direction: column;
    align-items: center;
    justify-content: center;
    padding: 4rem;
    color: var(--text-dim);
    gap: 1rem;
  }

  .spinner {
    width: 36px; height: 36px;
    border: 3px solid var(--border);
    border-top-color: var(--accent);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* Empty state */
  .empty-state {
    text-align: center;
    padding: 5rem 2rem;
    color: var(--text-faint);
  }
  .empty-state svg { width: 48px; height: 48px; margin-bottom: 1rem; opacity: 0.3; }
  .empty-state h3 { font-size: 1.1rem; color: var(--text-dim); margin-bottom: 0.5rem; }

  /* Error */
  .error-box {
    background: #7f1d1d20;
    border: 1px solid #dc262640;
    border-radius: 12px;
    padding: 1.25rem;
    color: #fca5a5;
    margin-bottom: 1.5rem;
  }
  .error-box strong { color: #f87171; }

  /* Stats bar */
  .stats-row {
    display: flex;
    gap: 0.75rem;
    margin-bottom: 1.5rem;
    flex-wrap: wrap;
    animation: fadeUp 0.5s ease 0.15s both;
  }

  .stat-card {
    flex: 1;
    min-width: 130px;
    background: var(--surface);
    border: 1px solid var(--border);
    border-radius: 12px;
    padding: 1rem 1.2rem;
    text-align: center;
  }
  .stat-card .stat-num {
    font-family: 'DM Serif Display', serif;
    font-size: 1.6rem;
    color: var(--text);
    line-height: 1;
    margin-bottom: 0.25rem;
  }
  .stat-card .stat-label {
    font-size: 0.72rem;
    text-transform: uppercase;
    letter-spacing: 0.5px;
    color: var(--text-faint);
    font-weight: 600;
  }

  /* Footer */
  .footer {
    text-align: center;
    padding: 2rem 0 1rem;
    color: var(--text-faint);
    font-size: 0.78rem;
  }

  /* Pagination */
  .pagination {
    display: flex;
    justify-content: center;
    align-items: center;
    gap: 0.5rem;
    padding: 1.25rem;
    border-top: 1px solid var(--border);
  }
  .page-btn {
    width: 36px; height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    border-radius: 8px;
    border: 1px solid var(--border);
    background: transparent;
    color: var(--text-dim);
    cursor: pointer;
    font-size: 0.85rem;
    font-weight: 500;
    transition: all 0.2s;
  }
  .page-btn:hover { border-color: var(--accent); color: var(--accent); }
  .page-btn.active { background: var(--accent); border-color: var(--accent); color: #fff; }
  .page-btn:disabled { opacity: 0.3; cursor: not-allowed; }
  .page-info { color: var(--text-faint); font-size: 0.8rem; margin: 0 0.5rem; }

  /* Responsive */
  @media (max-width: 768px) {
    .header h1 { font-size: 1.6rem; }
    .input-row { flex-direction: column; }
    .stats-row { gap: 0.5rem; }
    .stat-card { min-width: 80px; padding: 0.75rem; }
    .stat-card .stat-num { font-size: 1.2rem; }
    .status-bar { flex-direction: column; align-items: flex-start; }
    .filter-bar { flex-direction: column; }
  }
</style>
</head>
<body>
<div class="app" id="app">

  <!-- Header -->
  <div class="header">
    <div class="flag-bar"><span></span><span></span><span></span></div>
    <h1>Deputații României</h1>
    <p>Extractor date parlamentare — Camera Deputaților</p>
  </div>

  <!-- Input Section -->
  <div class="input-section">
    <div class="input-row">
      <input type="text" id="urlInput" placeholder="Introdu URL-ul cdep.ro..."
        value="https://www.cdep.ro/pls/parlam/structura2015.de?idl=1" />
      <button class="btn btn-primary" id="fetchBtn" onclick="fetchDeputies()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M4 16v1a3 3 0 003 3h10a3 3 0 003-3v-1m-4-4l-4 4m0 0l-4-4m4 4V4"/></svg>
        Extrage date
      </button>
    </div>
    <p class="hint">Exemplu: <code>https://www.cdep.ro/pls/parlam/structura2015.de?idl=1</code> — Folosește un CORS proxy automat</p>
  </div>

  <!-- Error box (hidden) -->
  <div class="error-box" id="errorBox" style="display:none;"></div>

  <!-- Stats -->
  <div class="stats-row" id="statsRow" style="display:none;">
    <div class="stat-card">
      <div class="stat-num" id="totalCount">0</div>
      <div class="stat-label">Total Deputați</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="partyCount">0</div>
      <div class="stat-label">Partide / Grupuri</div>
    </div>
    <div class="stat-card">
      <div class="stat-num" id="circCount">0</div>
      <div class="stat-label">Circumscripții</div>
    </div>
  </div>

  <!-- Status & Export -->
  <div class="status-bar" id="statusBar" style="display:none;">
    <div class="status-left">
      <div class="badge">
        <span class="dot green" id="statusDot"></span>
        <span id="statusText">Date încărcate</span>
      </div>
    </div>
    <div class="export-btns">
      <button class="btn btn-green" onclick="exportExcel()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 17v-2m3 2v-4m3 4v-6m2 10H7a2 2 0 01-2-2V5a2 2 0 012-2h5.586a1 1 0 01.707.293l5.414 5.414a1 1 0 01.293.707V19a2 2 0 01-2 2z"/></svg>
        Export Excel
      </button>
      <button class="btn btn-amber" onclick="exportCSV()">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M7 21h10a2 2 0 002-2V9.414a1 1 0 00-.293-.707l-5.414-5.414A1 1 0 0012.586 3H7a2 2 0 00-2 2v14a2 2 0 002 2z"/></svg>
        Export CSV
      </button>
    </div>
  </div>

  <!-- Filters -->
  <div class="filter-bar" id="filterBar" style="display:none;">
    <div class="search-box">
      <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M21 21l-6-6m2-5a7 7 0 11-14 0 7 7 0 0114 0z"/></svg>
      <input type="text" id="searchInput" placeholder="Caută deputat..." oninput="applyFilters()" />
    </div>
    <select class="filter-select" id="partyFilter" onchange="applyFilters()">
      <option value="">Toate partidele</option>
    </select>
    <select class="filter-select" id="circFilter" onchange="applyFilters()">
      <option value="">Toate circumscripțiile</option>
    </select>
  </div>

  <!-- Table -->
  <div class="table-wrap" id="tableWrap" style="display:none;">
    <div class="table-scroll">
      <table>
        <thead>
          <tr>
            <th onclick="sortBy('idx')"># <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('name')">Nume <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('party')">Grup parlamentar <span class="sort-icon">↕</span></th>
            <th onclick="sortBy('circ')">Circumscripție <span class="sort-icon">↕</span></th>
          </tr>
        </thead>
        <tbody id="tableBody"></tbody>
      </table>
    </div>
    <div class="pagination" id="pagination"></div>
  </div>

  <!-- Loading -->
  <div class="loading" id="loadingState" style="display:none;">
    <div class="spinner"></div>
    <span>Se extrag datele de pe cdep.ro...</span>
  </div>

  <!-- Empty state -->
  <div class="empty-state" id="emptyState">
    <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="1.5">
      <path stroke-linecap="round" stroke-linejoin="round" d="M19.5 14.25v-2.625a3.375 3.375 0 00-3.375-3.375h-1.5A1.125 1.125 0 0113.5 7.125v-1.5a3.375 3.375 0 00-3.375-3.375H8.25m2.25 0H5.625c-.621 0-1.125.504-1.125 1.125v17.25c0 .621.504 1.125 1.125 1.125h12.75c.621 0 1.125-.504 1.125-1.125V11.25a9 9 0 00-9-9z"/>
    </svg>
    <h3>Introdu un link CDEP</h3>
    <p>Apasă „Extrage date" pentru a prelua lista de deputați</p>
  </div>

  <div class="footer" id="footer" style="display:none;">
    Sursă date: <a href="https://www.cdep.ro" target="_blank" style="color:var(--accent);">cdep.ro</a> — Camera Deputaților a Parlamentului României
  </div>
</div>

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<script>
  let allDeputies = [];
  let filteredDeputies = [];
  let currentSort = { key: 'idx', asc: true };
  let currentPage = 1;
  const perPage = 50;

  const CORS_PROXIES = [
    url => `https://api.allorigins.win/raw?url=${encodeURIComponent(url)}`,
    url => `https://corsproxy.io/?${encodeURIComponent(url)}`,
    url => `https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(url)}`,
  ];

  async function fetchWithProxy(url) {
    for (let i = 0; i < CORS_PROXIES.length; i++) {
      try {
        const proxyUrl = CORS_PROXIES[i](url);
        const resp = await fetch(proxyUrl, { signal: AbortSignal.timeout(15000) });
        if (resp.ok) {
          const text = await resp.text();
          if (text.length > 500) return text;
        }
      } catch (e) {
        console.warn(`Proxy ${i} failed:`, e.message);
      }
    }
    throw new Error('Toate proxy-urile CORS au eșuat. Încearcă din nou sau accesează pagina direct.');
  }

  function parseDeputies(html) {
    const parser = new DOMParser();
    const doc = parser.parseFromString(html, 'text/html');
    const deputies = [];

    // The page lists deputies in table rows or links
    // Pattern: links to individual deputy pages with name
    const links = doc.querySelectorAll('a[href*="structura2015.mp?"]');

    if (links.length === 0) {
      // Try alternate parsing — look for table rows
      const rows = doc.querySelectorAll('table tr');
      rows.forEach(row => {
        const cells = row.querySelectorAll('td');
        if (cells.length >= 2) {
          const nameLink = cells[0]?.querySelector('a') || cells[1]?.querySelector('a');
          if (nameLink && nameLink.href.includes('structura')) {
            const name = nameLink.textContent.trim();
            if (name && name.length > 2) {
              deputies.push({
                name: name,
                party: cells[1]?.textContent?.trim() || '',
                circ: cells[2]?.textContent?.trim() || '',
                link: nameLink.getAttribute('href') || ''
              });
            }
          }
        }
      });
    }

    // Primary parsing: look for the deputy list pattern
    if (deputies.length === 0) {
      // cdep.ro uses <td> with class or within specific tables
      const allTables = doc.querySelectorAll('table');
      for (const table of allTables) {
        const rows = table.querySelectorAll('tr');
        for (const row of rows) {
          const tds = row.querySelectorAll('td');
          if (tds.length >= 1) {
            const a = row.querySelector('a[href*=".mp"]') || row.querySelector('a[href*="structura"]');
            if (a) {
              const name = a.textContent.trim();
              if (name.length > 3 && /[A-ZĂÂÎȘȚ]/.test(name)) {
                let party = '', circ = '';
                // Try to extract party and circ from sibling cells
                tds.forEach((td, idx) => {
                  const text = td.textContent.trim();
                  if (td.contains(a)) return;
                  if (!party && (text.includes('PSD') || text.includes('PNL') || text.includes('USR') ||
                      text.includes('AUR') || text.includes('UDMR') || text.includes('Minor') ||
                      text.includes('neafiliat') || text.length < 30)) {
                    if (idx > 0) party = text;
                  }
                  if (!circ && text.includes('Nr.')) circ = text;
                  if (!circ && /\d+/.test(text) && text.length < 40 && idx > 1) circ = text;
                });
                deputies.push({
                  name,
                  party: party || 'Nedeterminat',
                  circ: circ || '-',
                  link: a.getAttribute('href') || ''
                });
              }
            }
          }
        }
      }
    }

    // Also try: the page may use <div> or <span> patterns
    if (deputies.length === 0) {
      // Broad search for all links that look like deputy links
      const allLinks = doc.querySelectorAll('a');
      allLinks.forEach(a => {
        const href = a.getAttribute('href') || '';
        const name = a.textContent.trim();
        if ((href.includes('.mp?') || href.includes('structura')) && name.length > 4 && /[A-ZĂÂÎȘȚ]/.test(name[0])) {
          // Try to get context from parent
          const parent = a.closest('tr') || a.closest('td') || a.parentElement;
          const parentText = parent ? parent.textContent : '';
          deputies.push({
            name,
            party: extractParty(parentText, name),
            circ: extractCirc(parentText),
            link: href
          });
        }
      });
    }

    // Deduplicate
    const seen = new Set();
    return deputies.filter(d => {
      const key = d.name;
      if (seen.has(key)) return false;
      seen.add(key);
      return true;
    });
  }

  function extractParty(text, name) {
    const parties = ['PSD', 'PNL', 'USR', 'AUR', 'UDMR'];
    const lower = text.toLowerCase();
    for (const p of parties) {
      if (lower.includes(p.toLowerCase())) return p;
    }
    if (lower.includes('minorit')) return 'Minorități';
    if (lower.includes('neafiliat')) return 'Neafiliat';
    return '';
  }

  function extractCirc(text) {
    const match = text.match(/Nr\.\s*\d+/i) || text.match(/Circ[^:]*:\s*([^\n,]+)/i);
    return match ? match[0] : '';
  }

  function getPartyClass(party) {
    if (!party) return 'party-default';
    const p = party.toUpperCase();
    if (p.includes('PSD')) return 'party-PSD';
    if (p.includes('PNL')) return 'party-PNL';
    if (p.includes('USR')) return 'party-USR';
    if (p.includes('AUR')) return 'party-AUR';
    if (p.includes('UDMR')) return 'party-UDMR';
    if (p.includes('MINOR')) return 'party-MIN';
    if (p.includes('NEAFIL')) return 'party-NEA';
    return 'party-default';
  }

  async function fetchDeputies() {
    const url = document.getElementById('urlInput').value.trim();
    if (!url) return;

    showLoading(true);
    hideError();

    try {
      const html = await fetchWithProxy(url);
      allDeputies = parseDeputies(html);

      if (allDeputies.length === 0) {
        showError('Nu s-au putut extrage deputați din pagina dată. Verifică URL-ul sau structura paginii.');
        showLoading(false);
        return;
      }

      // Add index
      allDeputies.forEach((d, i) => d.idx = i + 1);

      // Populate filters
      populateFilters();
      applyFilters();
      updateStats();

      // Show UI
      document.getElementById('statsRow').style.display = 'flex';
      document.getElementById('statusBar').style.display = 'flex';
      document.getElementById('filterBar').style.display = 'flex';
      document.getElementById('tableWrap').style.display = 'block';
      document.getElementById('emptyState').style.display = 'none';
      document.getElementById('footer').style.display = 'block';

    } catch (err) {
      showError(`Eroare la extragerea datelor: ${err.message}`);
    }

    showLoading(false);
  }

  function populateFilters() {
    const partySet = new Set(allDeputies.map(d => d.party).filter(Boolean));
    const circSet = new Set(allDeputies.map(d => d.circ).filter(Boolean));

    const partySelect = document.getElementById('partyFilter');
    partySelect.innerHTML = '<option value="">Toate partidele</option>';
    [...partySet].sort().forEach(p => {
      const count = allDeputies.filter(d => d.party === p).length;
      partySelect.innerHTML += `<option value="${p}">${p} (${count})</option>`;
    });

    const circSelect = document.getElementById('circFilter');
    circSelect.innerHTML = '<option value="">Toate circumscripțiile</option>';
    [...circSet].sort().forEach(c => {
      circSelect.innerHTML += `<option value="${c}">${c}</option>`;
    });
  }

  function applyFilters() {
    const search = document.getElementById('searchInput').value.toLowerCase();
    const party = document.getElementById('partyFilter').value;
    const circ = document.getElementById('circFilter').value;

    filteredDeputies = allDeputies.filter(d => {
      if (search && !d.name.toLowerCase().includes(search)) return false;
      if (party && d.party !== party) return false;
      if (circ && d.circ !== circ) return false;
      return true;
    });

    // Sort
    sortData();
    currentPage = 1;
    renderTable();
    document.getElementById('statusText').textContent = `${filteredDeputies.length} din ${allDeputies.length} deputați`;
  }

  function sortBy(key) {
    if (currentSort.key === key) {
      currentSort.asc = !currentSort.asc;
    } else {
      currentSort.key = key;
      currentSort.asc = true;
    }
    sortData();
    renderTable();
  }

  function sortData() {
    const { key, asc } = currentSort;
    filteredDeputies.sort((a, b) => {
      let va = a[key] || '';
      let vb = b[key] || '';
      if (key === 'idx') { va = Number(va); vb = Number(vb); }
      else { va = va.toString().toLowerCase(); vb = vb.toString().toLowerCase(); }
      if (va < vb) return asc ? -1 : 1;
      if (va > vb) return asc ? 1 : -1;
      return 0;
    });
  }

  function renderTable() {
    const tbody = document.getElementById('tableBody');
    const totalPages = Math.ceil(filteredDeputies.length / perPage);
    const start = (currentPage - 1) * perPage;
    const pageData = filteredDeputies.slice(start, start + perPage);

    tbody.innerHTML = pageData.map(d => {
      const fullLink = d.link.startsWith('http') ? d.link : `https://www.cdep.ro/pls/parlam/${d.link}`;
      return `<tr>
        <td class="idx">${d.idx}</td>
        <td class="name-cell"><a href="${fullLink}" target="_blank" rel="noopener">${d.name}</a></td>
        <td><span class="party-badge ${getPartyClass(d.party)}">${d.party || '-'}</span></td>
        <td class="circ">${d.circ || '-'}</td>
      </tr>`;
    }).join('');

    renderPagination(totalPages);
  }

  function renderPagination(totalPages) {
    const pag = document.getElementById('pagination');
    if (totalPages <= 1) { pag.innerHTML = ''; return; }

    let html = `<button class="page-btn" onclick="goPage(${currentPage - 1})" ${currentPage === 1 ? 'disabled' : ''}>&laquo;</button>`;

    const range = 2;
    for (let i = 1; i <= totalPages; i++) {
      if (i === 1 || i === totalPages || (i >= currentPage - range && i <= currentPage + range)) {
        html += `<button class="page-btn ${i === currentPage ? 'active' : ''}" onclick="goPage(${i})">${i}</button>`;
      } else if (i === currentPage - range - 1 || i === currentPage + range + 1) {
        html += `<span class="page-info">…</span>`;
      }
    }

    html += `<button class="page-btn" onclick="goPage(${currentPage + 1})" ${currentPage === totalPages ? 'disabled' : ''}>&raquo;</button>`;
    pag.innerHTML = html;
  }

  function goPage(p) {
    const totalPages = Math.ceil(filteredDeputies.length / perPage);
    if (p < 1 || p > totalPages) return;
    currentPage = p;
    renderTable();
    document.getElementById('tableWrap').scrollIntoView({ behavior: 'smooth', block: 'start' });
  }

  function updateStats() {
    document.getElementById('totalCount').textContent = allDeputies.length;
    document.getElementById('partyCount').textContent = new Set(allDeputies.map(d => d.party).filter(Boolean)).size;
    document.getElementById('circCount').textContent = new Set(allDeputies.map(d => d.circ).filter(Boolean)).size;
  }

  function exportExcel() {
    if (filteredDeputies.length === 0) return;
    const data = filteredDeputies.map(d => ({
      'Nr.': d.idx,
      'Nume': d.name,
      'Grup Parlamentar': d.party,
      'Circumscripție': d.circ
    }));
    const ws = XLSX.utils.json_to_sheet(data);

    // Column widths
    ws['!cols'] = [
      { wch: 5 },
      { wch: 35 },
      { wch: 20 },
      { wch: 25 }
    ];

    const wb = XLSX.utils.book_new();
    XLSX.utils.book_append_sheet(wb, ws, 'Deputați');
    XLSX.writeFile(wb, 'deputati_romania.xlsx');
  }

  function exportCSV() {
    if (filteredDeputies.length === 0) return;
    const BOM = '\uFEFF';
    const header = 'Nr.,Nume,Grup Parlamentar,Circumscripție\n';
    const rows = filteredDeputies.map(d =>
      `${d.idx},"${d.name.replace(/"/g, '""')}","${(d.party || '').replace(/"/g, '""')}","${(d.circ || '').replace(/"/g, '""')}"`
    ).join('\n');

    const blob = new Blob([BOM + header + rows], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = 'deputati_romania.csv';
    link.click();
    URL.revokeObjectURL(link.href);
  }

  function showLoading(show) {
    document.getElementById('loadingState').style.display = show ? 'flex' : 'none';
    document.getElementById('fetchBtn').disabled = show;
    if (show) document.getElementById('emptyState').style.display = 'none';
  }

  function showError(msg) {
    const box = document.getElementById('errorBox');
    box.innerHTML = `<strong>⚠ Eroare:</strong> ${msg}`;
    box.style.display = 'block';
  }

  function hideError() {
    document.getElementById('errorBox').style.display = 'none';
  }

  // Enter key support
  document.getElementById('urlInput').addEventListener('keydown', e => {
    if (e.key === 'Enter') fetchDeputies();
  });
</script>
</body>
</html>
