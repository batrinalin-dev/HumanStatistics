<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDEP Parlamentar Scraper</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#0b0e13;--surface:#12161e;--surface2:#181d28;--border:#232a3a;--border-focus:#3b82f6;--text:#e2e8f0;--text-dim:#6b7a90;--accent:#3b82f6;--accent-hover:#2563eb;--accent-glow:rgba(59,130,246,.13);--green:#22c55e;--green-dim:rgba(34,197,94,.10);--red:#ef4444;--red-dim:rgba(239,68,68,.08);--amber:#f59e0b;--amber-dim:rgba(245,158,11,.10);--radius:10px;--font:'DM Sans',sans-serif;--mono:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(59,130,246,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,.025) 1px,transparent 1px);background-size:56px 56px;pointer-events:none}
.app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:36px 40px 60px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:36px}
.header-icon{width:50px;height:50px;background:linear-gradient(135deg,var(--accent),#818cf8);border-radius:14px;display:grid;place-items:center;font-size:24px;box-shadow:0 0 28px var(--accent-glow);flex-shrink:0}
.header h1{font-size:22px;font-weight:700;letter-spacing:-.4px}
.header h1 span{color:var(--accent)}
.header p{color:var(--text-dim);font-size:13px;margin-top:2px}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:26px 28px;margin-bottom:24px}
.panel label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.9px;margin-bottom:10px}
.input-row{display:flex;gap:12px}
textarea{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--mono);font-size:12.5px;padding:14px 16px;resize:vertical;min-height:88px;line-height:1.75;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-glow)}
textarea::placeholder{color:var(--text-dim);opacity:.45}
.hint{font-size:11.5px;color:var(--text-dim);margin-top:10px;line-height:1.55}
.method-row{display:flex;gap:16px;margin-top:16px;align-items:center;flex-wrap:wrap}
.method-row>span{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px}
.method-radio{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12.5px;color:var(--text)}
.method-radio input{accent-color:var(--accent)}
.proxy-input{background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 12px;width:320px}
.proxy-input:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-glow)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;border:none;border-radius:8px;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn svg{width:15px;height:15px;flex-shrink:0}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 0 20px var(--accent-glow)}
.btn-primary:hover:not(:disabled){background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 24px rgba(59,130,246,.28)}
.btn-primary:disabled{opacity:.35;cursor:not-allowed;transform:none}
.btn-out{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-out:hover:not(:disabled){background:var(--border);transform:translateY(-1px)}
.btn-out:disabled{opacity:.25;cursor:not-allowed;transform:none}
.status{display:none;align-items:center;gap:12px;padding:13px 20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;font-size:13px}
.status.vis{display:flex}.status.ld{border-color:var(--accent);background:var(--accent-glow)}.status.ok{border-color:var(--green);background:var(--green-dim)}.status.er{border-color:var(--red);background:var(--red-dim)}
.spin{width:17px;height:17px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
.status .num{font-family:var(--mono);color:var(--accent);font-weight:500;margin-left:auto}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.toolbar-l{font-size:13px;color:var(--text-dim)}.toolbar-l strong{color:var(--text);font-family:var(--mono)}
.toolbar-r{display:flex;gap:10px}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden}
.ts{overflow-x:auto;max-height:70vh;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{background:var(--surface2);color:var(--text-dim);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.8px;padding:14px 18px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:2}
tbody tr{border-bottom:1px solid var(--border);transition:background .12s}
tbody tr:hover{background:rgba(59,130,246,.035)}
tbody tr:last-child{border-bottom:none}
td{padding:12px 18px;vertical-align:middle;line-height:1.5}
td.nc{font-weight:600;white-space:nowrap}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;font-family:var(--mono)}
.b-com{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(245,158,11,.18)}
.b-role{background:var(--green-dim);color:var(--green);border:1px solid rgba(34,197,94,.18)}
.b-role.none{color:var(--text-dim);background:transparent;border-color:var(--border)}
.empty{text-align:center;padding:72px 40px;color:var(--text-dim)}
.empty .ico{font-size:44px;margin-bottom:14px;opacity:.35}
.empty h3{font-size:15px;color:var(--text);margin-bottom:6px}
.empty p{font-size:12.5px}
.info-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;margin-bottom:20px;font-size:12.5px;color:var(--text-dim);line-height:1.7}
.info-box code{background:var(--surface2);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:11.5px;color:var(--accent)}
.info-box strong{color:var(--text)}
.debug-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-top:20px;font-size:11.5px;font-family:var(--mono);color:var(--text-dim);line-height:1.7;max-height:500px;overflow-y:auto;white-space:pre-wrap;display:none}
.debug-box.vis{display:block}
@keyframes sp{to{transform:rotate(360deg)}}
@media(max-width:700px){.app{padding:16px}.input-row{flex-direction:column}.toolbar{flex-direction:column;gap:10px;align-items:flex-start}.method-row{flex-direction:column;gap:8px}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-icon">üèõ</div>
    <div><h1>CDEP <span>Scraper</span></h1><p>Extragere date parlamentari ‚Äî Camera Deputa»õilor</p></div>
  </div>
  <div class="info-box">
    <strong>‚ö† cdep.ro blocheazƒÉ accesul direct (CORS).</strong><br>
    <strong>‚ë† Proxy local:</strong> <code>npx cors-anywhere</code> ‚Üí <code>http://localhost:8080</code><br>
    <strong>‚ë° Extensie CORS:</strong> <strong>"Allow CORS"</strong> / <strong>"CORS Unblock"</strong><br>
    <strong>‚ë¢ Proxy public:</strong> FƒÉrƒÉ instalare, poate fi lent.
  </div>
  <div class="panel">
    <label>Link-uri pagini parlamentari (c√¢te un link pe linie)</label>
    <div class="input-row">
      <textarea id="inp" placeholder="https://www.cdep.ro/pls/parlam/structura2015.mp?idm=1&cam=2&leg=2024
https://www.cdep.ro/pls/parlam/structura2015.mp?idm=204&cam=2&leg=2020"></textarea>
      <button class="btn btn-primary" id="btnGo" onclick="run()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M9 12l2 2 4-4"/></svg>
        Extrage
      </button>
    </div>
    <div class="method-row">
      <span>MetodƒÉ acces:</span>
      <label class="method-radio"><input type="radio" name="method" value="proxy" checked onchange="toggleProxy()"> Proxy local</label>
      <label class="method-radio"><input type="radio" name="method" value="direct" onchange="toggleProxy()"> Direct (extensie CORS)</label>
      <label class="method-radio"><input type="radio" name="method" value="public" onchange="toggleProxy()"> Proxy public</label>
    </div>
    <div id="proxyRow" style="margin-top:12px">
      <input class="proxy-input" id="proxyUrl" value="http://localhost:8080/">
      <span style="font-size:11px;color:var(--text-dim);margin-left:8px">URL proxy local</span>
    </div>
    <p class="hint"><strong>LogicƒÉ selec»õie comisie (doar din ‚ÄûComisii permanente"):</strong><br>
    ‚ë† Se verificƒÉ dacƒÉ vreo comisie are func»õie (Pre»ôedinte / Vicepre»ôedinte / Secretar) ‚Üí se alege acea comisie.<br>
    ‚ë° DacƒÉ nicio comisie nu are func»õie ‚Üí se alege comisia cu data cea mai recentƒÉ.</p>
  </div>
  <div class="status" id="st"><div class="spin" id="stSpin"></div><span id="stTxt"></span><span class="num" id="stNum"></span></div>
  <div class="toolbar">
    <div class="toolbar-l" id="cnt"></div>
    <div class="toolbar-r">
      <button class="btn btn-out" id="bCSV" onclick="expCSV()" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>CSV</button>
      <button class="btn btn-out" id="bXL" onclick="expXL()" disabled><svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>Excel</button>
    </div>
  </div>
  <div id="out"><div class="empty"><div class="ico">üìã</div><h3>Niciun rezultat</h3><p>Introduce»õi link-uri »ôi apƒÉsa»õi ‚ÄûExtrage".</p></div></div>
  <div class="debug-box" id="dbg"></div>
</div>

<script>
const COM_KW={
  0:["agricultura","silvicultur"],1:["buget","finant","financ","banci","banc"],
  2:["cultura","arta","informational"],3:["aparar","ordine publica","sigurant"],
  4:["economi","reforma","reform","privatiz","antreprenoriat"],
  5:["educati","stiint","tineret","sport"],6:["externe","afaceri externe"],
  7:["sanat","familie"],8:["drepturile omului","culte","minorit"],
  9:["industri","servicii"],10:["justiti","contestat"],
  11:["ordine de drept","ordinii de drept"],12:["administratie","mediu"],
  13:["munca","muncii","protecti","sociala"],14:["integrar","european"],
  16:["abuz","corupti","petiti"],17:["egalitat","sanse"],
  18:["tehnologi","informati","comunicati"],19:["regulament"],
  20:["juridic","disciplin","imunitat"],21:["regulamente"],22:["centenar"],
  23:["spatiu","subcomisi"],24:["revizuir"],
  25:["revoluti","1989"],26:["transport","energi","infrastructur"],
  27:["diaspora"],28:["SIE","controlul activit"],29:["constitutionalitate"],
};
const COM_NAME={0:"AgriculturƒÉ",1:"Buget/Finan»õe",2:"CulturƒÉ",3:"ApƒÉrare",4:"Economie",5:"Educa»õie",6:"Afaceri externe",7:"SƒÉnƒÉtate",8:"Drepturile omului",9:"Industrie",10:"Justi»õie",11:"Ordine de drept",12:"Admin. publicƒÉ",13:"MuncƒÉ",14:"Integrare EU",15:"FƒÉrƒÉ comisie",16:"Abuzuri/Corup»õie",17:"Egalitate »ôanse",18:"IT&C",19:"Regulament",20:"JuridicƒÉ",21:"Regulamente",22:"Centenar",23:"Spa»õiu",24:"Revizuire Const.",25:"Revolu»õia 1989",26:"Transport/Energie",27:"Diaspora",28:"Control SIE",29:"Constitu»õionalitate",99:"FƒÉrƒÉ date"};
const ROLE_NAME={0:"FƒÉrƒÉ func»õie",1:"Pre»ôedinte",2:"Vicepre»ôedinte",3:"Secretar"};
const MO={"ian":1,"ianuarie":1,"feb":2,"februarie":2,"mar":3,"martie":3,"apr":4,"aprilie":4,"mai":5,"iun":6,"iunie":6,"iul":7,"iulie":7,"aug":8,"august":8,"sep":9,"sept":9,"septembrie":9,"oct":10,"octombrie":10,"nov":11,"noiembrie":11,"dec":12,"decembrie":12};

/*
 * Strip ALL diacritics using NFKD decomposition.
 * Works regardless of encoding issues (ƒÉ, √¢, √Æ, ≈ü, ≈£, »ô, »õ, √£, etc.)
 * "Comisia pentru muncƒÉ ≈üi protec≈£ie socialƒÉ" ‚Üí "comisia pentru munca si protectie sociala"
 */
function flat(s){
  // Step 1: Known Romanian replacements (handles both old and new diacritics)
  s=s.replace(/\u015f/g,"s").replace(/\u015e/g,"S"); // ≈ü‚Üís
  s=s.replace(/\u0163/g,"t").replace(/\u0162/g,"T"); // ≈£‚Üít
  s=s.replace(/[»ô»ò]/g,"s").replace(/[»õ»ö]/g,"t");
  s=s.replace(/[ƒÉƒÇ]/g,"a").replace(/[√¢√Ç]/g,"a").replace(/[√Æ√é]/g,"i");
  // Step 2: NFKD decomposition strips remaining accents (√£‚Üía, √©‚Üíe, etc.)
  s=s.normalize("NFKD").replace(/[\u0300-\u036f]/g,"");
  return s.toLowerCase();
}

function norm(s){return s.replace(/\u015f/g,"»ô").replace(/\u015e/g,"»ò").replace(/\u0163/g,"»õ").replace(/\u0162/g,"»ö")}

function detectRole(text){
  const n=flat(text);
  let role=0;
  if(/vicepresedinte/.test(n)) role=2;
  if(/(?<!vice)presedinte/.test(n)) role=1;
  if(/secretar/.test(n)&&role===0) role=3;
  return role;
}
function parseRoDate(str){
  if(!str)return 0;
  const s=flat(str).replace(/\./g,"").trim();
  const m=s.match(/([a-z]+)\s*(\d{4})/);
  if(!m)return 0;
  const mon=MO[m[1]],yr=parseInt(m[2]);
  return(mon&&yr)?yr*100+mon:0;
}
function idCom(text){
  const low=flat(text);
  let best=null,bestN=0;
  for(const[code,kws]of Object.entries(COM_KW)){
    const n=kws.filter(k=>low.includes(k)).length;
    if(n>bestN){bestN=n;best=parseInt(code);}
  }
  return best;
}

let results=[],debugLog=[];

function toggleProxy(){document.getElementById("proxyRow").style.display=document.querySelector('input[name="method"]:checked').value==="proxy"?"block":"none"}
const PUB_PX=[u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`];

/*
 * Fetch with encoding detection.
 * Tries UTF-8 first, if garbled (replacement char U+FFFD) falls back to ISO-8859-2/Windows-1252.
 */
async function grab(url){
  const method=document.querySelector('input[name="method"]:checked').value;
  let resp;
  if(method==="direct"){resp=await fetch(url,{signal:AbortSignal.timeout(25000)});if(!resp.ok)throw new Error(`HTTP ${resp.status}`);}
  else if(method==="proxy"){let base=document.getElementById("proxyUrl").value.trim();if(!base.endsWith("/"))base+="/";resp=await fetch(base+url,{signal:AbortSignal.timeout(25000)});if(!resp.ok)throw new Error(`Proxy ‚Üí HTTP ${resp.status}`);}
  else{
    for(const pf of PUB_PX){try{resp=await fetch(pf(url),{signal:AbortSignal.timeout(20000)});if(resp.ok)break;resp=null;}catch(e){resp=null;}}
    if(!resp)throw new Error("Proxy-urile publice au e»ôuat");
  }
  // Try to decode with correct encoding
  const buf=await resp.arrayBuffer();
  // Try UTF-8 first
  let text=new TextDecoder("utf-8").decode(buf);
  // Check for garbled chars (replacement character U+FFFD)
  if(text.includes("\uFFFD")){
    debugLog.push("  ‚ö† UTF-8 garbled, trying ISO-8859-2...");
    text=new TextDecoder("iso-8859-2").decode(buf);
  }
  return text;
}

function getName(doc){
  const title=doc.querySelector("title");
  if(title){const t=title.textContent.trim();if(t.length>3&&t.length<60&&!/(camera|cdep|parlament|legislat)/i.test(t))return t;}
  for(const tag of["h1","h2","h3"]){for(const el of doc.querySelectorAll(tag)){const t=el.textContent.trim();if(t.length>4&&t.length<80&&!/(camera|comisi|parlament|structur|legislat)/i.test(t))return t;}}
  return "Necunoscut";
}

/*
 * Parse committees from "Comisii permanente" section.
 * DOM-based: find h3 ‚Üí parent .boxDep ‚Üí walk <a> siblings.
 * Uses flat() for diacritic-proof keyword matching.
 */
function getCommittee(doc, mpName){
  const log=[];

  let box=null;
  for(const h3 of doc.querySelectorAll("h3")){
    if(/comisii\s+permanente/i.test(h3.textContent.normalize("NFKD"))){
      box=h3.closest(".boxDep")||h3.parentElement;
      break;
    }
  }
  if(!box){
    log.push(`‚ùå <h3>Comisii permanente</h3> negƒÉsit`);
    debugLog.push(`\n‚ñ∏ ${mpName}:`);log.forEach(l=>debugLog.push("  "+l));
    debugLog.push("  ‚Üí cod=99 func»õie=0");
    return{comisie:99,functie:0};
  }
  log.push(`‚úÖ Sec»õiune gƒÉsitƒÉ (tag=${box.tagName}, class="${box.className}")`);

  const links=[...box.querySelectorAll('a[href*="structura2015.co"]')];
  log.push(`Link-uri <a>: ${links.length}`);

  if(!links.length){
    debugLog.push(`\n‚ñ∏ ${mpName}:`);log.forEach(l=>debugLog.push("  "+l));
    debugLog.push("  ‚Üí cod=99 func»õie=0");
    return{comisie:99,functie:0};
  }

  const entries=[];
  for(let i=0;i<links.length;i++){
    const a=links[i];
    const comName=a.textContent.trim();
    const comFlat=flat(comName);
    const code=idCom(comName);

    let trail="";
    let node=a.nextSibling;
    while(node){
      if(node.nodeType===Node.TEXT_NODE) trail+=node.textContent;
      else if(node.nodeType===Node.ELEMENT_NODE){
        if(node.tagName==="A"&&(node.getAttribute("href")||"").includes("structura2015.co")) break;
        if(node.tagName!=="BR") trail+=node.textContent;
      }
      node=node.nextSibling;
    }
    trail=trail.trim();

    const role=detectRole(trail);

    log.push(`  ${i+1}. "${comFlat.substring(0,55)}" ‚Üí cod=${code!==null?code:"NULL"}`);
    log.push(`     trail="${trail.substring(0,60)}" role=${role}(${ROLE_NAME[role]||"?"})`);

    if(code===null){log.push(`     ‚äò SKIP`);continue;}

    let joinDate=0,isActive=true;
    const trailF=flat(trail);
    const dinM=trailF.match(/\bdin\s+([a-z]+\.?\s*\d{4})/);
    if(dinM){joinDate=parseRoDate(dinM[1]);isActive=true;}
    const panaM=trailF.match(/pana\s+in\s+([a-z]+\.?\s*\d{4})/);
    if(panaM){isActive=false;joinDate=0;}
    if(!dinM&&!panaM){
      const rangeM=trailF.match(/([a-z]+\.?\s*\d{4})\s*-\s*([a-z]+\.?\s*\d{4})/);
      if(rangeM){joinDate=parseRoDate(rangeM[1]);isActive=false;}
    }

    entries.push({code,role,joinDate,isActive,name:comName});
    log.push(`     ‚Üí [${code}] ${COM_NAME[code]} data=${joinDate} active=${isActive}`);
  }

  debugLog.push(`\n‚ñ∏ ${mpName}: ${entries.length} comisii permanente (din ${links.length} link-uri)`);
  log.forEach(l=>debugLog.push("  "+l));

  if(!entries.length){
    debugLog.push("  ‚Üí cod=99 func»õie=0");
    return{comisie:99,functie:0};
  }

  // P1: Vreo comisie are func»õie?
  const withRole=entries.filter(e=>e.role>0);
  if(withRole.length>0){
    withRole.sort((a,b)=>a.role-b.role);
    const w=withRole[0];
    debugLog.push(`  ‚îÄ‚îÄ‚îÄ P1: FUNC»öIE GƒÇSITƒÇ ‚îÄ‚îÄ‚îÄ`);
    debugLog.push(`  ‚Üí ${ROLE_NAME[w.role]} la [${w.code}] ${COM_NAME[w.code]}`);
    return{comisie:w.code,functie:w.role};
  }

  // P2: Nicio func»õie ‚Üí cea mai recentƒÉ datƒÉ
  debugLog.push(`  ‚îÄ‚îÄ‚îÄ P2: NICIO FUNC»öIE ‚îÄ‚îÄ‚îÄ`);
  let cands=entries.filter(e=>e.isActive);
  if(!cands.length)cands=entries;
  cands.sort((a,b)=>b.joinDate-a.joinDate);
  const w=cands[0];
  debugLog.push(`  ‚Üí [${w.code}] ${COM_NAME[w.code]} (data=${w.joinDate}) func»õie=0`);
  return{comisie:w.code,functie:0};
}

async function processURL(url){
  const rawHTML=await grab(url);
  const doc=new DOMParser().parseFromString(rawHTML,"text/html");
  const name=getName(doc);
  const{comisie,functie}=getCommittee(doc,name);
  return{nume:name,comisie,comisie_label:COM_NAME[comisie]||"FƒÉrƒÉ date",functie,functie_label:ROLE_NAME[functie]||"FƒÉrƒÉ func»õie",url};
}

async function run(){
  const raw=document.getElementById("inp").value.trim();if(!raw)return;
  const urls=raw.split(/\n/).map(l=>l.trim()).filter(l=>l.startsWith("http"));
  if(!urls.length){setSt("er","Nu s-au gƒÉsit link-uri valide.");return;}
  document.getElementById("btnGo").disabled=true;
  results=[];debugLog=["‚ïê‚ïê‚ïê LOG PROCESARE ‚ïê‚ïê‚ïê","","P1: Comisie cu func»õie ‚Üí se alege acea comisie","P2: Nicio func»õie ‚Üí cea mai recentƒÉ datƒÉ",""];
  setSt("ld","Se proceseazƒÉ...",`0 / ${urls.length}`);
  for(let i=0;i<urls.length;i++){
    try{updSt(`${urls[i].substring(0,60)}...`,`${i+1} / ${urls.length}`);results.push(await processURL(urls[i]));}
    catch(e){results.push({nume:"‚ùå Eroare",comisie:99,comisie_label:e.message.substring(0,50),functie:0,functie_label:"‚Äî",url:urls[i]});debugLog.push(`\n‚ñ∏ EROARE: ${e.message}`);}
    render(results);if(i<urls.length-1)await new Promise(r=>setTimeout(r,600));
  }
  setSt("ok",`Finalizat! ${results.length} parlamentari procesa»õi.`);
  document.getElementById("bCSV").disabled=false;document.getElementById("bXL").disabled=false;document.getElementById("btnGo").disabled=false;
  const dbg=document.getElementById("dbg");dbg.textContent=debugLog.join("\n");dbg.classList.add("vis");
}

function render(data){
  document.getElementById("cnt").innerHTML=`<strong>${data.length}</strong> rezultate`;
  if(!data.length){document.getElementById("out").innerHTML=`<div class="empty"><div class="ico">üìã</div><h3>Niciun rezultat</h3><p>Introduce»õi link-uri »ôi apƒÉsa»õi ‚ÄûExtrage".</p></div>`;return;}
  let h=`<div class="tw"><div class="ts"><table><thead><tr><th style="width:40%">Nume</th><th style="width:36%">Comisie</th><th style="width:24%">Func»õie</th></tr></thead><tbody>`;
  for(const r of data){h+=`<tr><td class="nc">${esc(r.nume)}</td><td><span class="badge b-com">${r.comisie} ‚Äî ${esc(r.comisie_label)}</span></td><td><span class="badge ${r.functie===0?"b-role none":"b-role"}">${r.functie} ‚Äî ${esc(r.functie_label)}</span></td></tr>`;}
  h+=`</tbody></table></div></div>`;document.getElementById("out").innerHTML=h;
}

function expCSV(){if(!results.length)return;dl("\uFEFF"+"Nume,Comisie,Func»õie\n"+results.map(r=>[r.nume,r.comisie,r.functie].map(v=>`"${String(v).replace(/"/g,'""')}"`).join(",")).join("\n"),"parlamentari.csv","text/csv;charset=utf-8;")}
function expXL(){if(!results.length)return;const ws=XLSX.utils.aoa_to_sheet([["Nume","Comisie","Func»õie"],...results.map(r=>[r.nume,r.comisie,r.functie])]);ws['!cols']=[{wch:35},{wch:12},{wch:12}];const wb=XLSX.utils.book_new();XLSX.utils.book_append_sheet(wb,ws,"Parlamentari");XLSX.writeFile(wb,"parlamentari.xlsx")}

function esc(s){const d=document.createElement("div");d.textContent=String(s);return d.innerHTML}
function dl(c,f,t){const b=new Blob([c],{type:t}),a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=f;a.click();URL.revokeObjectURL(a.href)}
function setSt(type,txt,num){const b=document.getElementById("st");b.className=`status vis ${type}`;document.getElementById("stTxt").textContent=txt;document.getElementById("stNum").textContent=num||"";document.getElementById("stSpin").style.display=type==="ld"?"block":"none"}
function updSt(txt,num){document.getElementById("stTxt").textContent=txt;document.getElementById("stNum").textContent=num||""}
</script>
</body>
</html>
