<!DOCTYPE html>
<html lang="ro">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>CDEP Parlamentar Scraper</title>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:ital,wght@0,400;0,500;0,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
<style>
:root{--bg:#0b0e13;--surface:#12161e;--surface2:#181d28;--border:#232a3a;--border-focus:#3b82f6;--text:#e2e8f0;--text-dim:#6b7a90;--accent:#3b82f6;--accent-hover:#2563eb;--accent-glow:rgba(59,130,246,.13);--green:#22c55e;--green-dim:rgba(34,197,94,.10);--red:#ef4444;--red-dim:rgba(239,68,68,.08);--amber:#f59e0b;--amber-dim:rgba(245,158,11,.10);--radius:10px;--font:'DM Sans',sans-serif;--mono:'JetBrains Mono',monospace}
*{margin:0;padding:0;box-sizing:border-box}
body{background:var(--bg);color:var(--text);font-family:var(--font);min-height:100vh}
body::before{content:'';position:fixed;inset:0;background-image:linear-gradient(rgba(59,130,246,.025) 1px,transparent 1px),linear-gradient(90deg,rgba(59,130,246,.025) 1px,transparent 1px);background-size:56px 56px;pointer-events:none}
.app{position:relative;z-index:1;max-width:1100px;margin:0 auto;padding:36px 40px 60px}
.header{display:flex;align-items:center;gap:16px;margin-bottom:36px;animation:fadeD .5s ease}
.header-icon{width:50px;height:50px;background:linear-gradient(135deg,var(--accent),#818cf8);border-radius:14px;display:grid;place-items:center;font-size:24px;box-shadow:0 0 28px var(--accent-glow);flex-shrink:0}
.header h1{font-size:22px;font-weight:700;letter-spacing:-.4px}
.header h1 span{color:var(--accent)}
.header p{color:var(--text-dim);font-size:13px;margin-top:2px}
.panel{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:26px 28px;margin-bottom:24px;animation:fadeD .55s ease}
.panel label{display:block;font-size:12px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.9px;margin-bottom:10px}
.input-row{display:flex;gap:12px}
textarea{flex:1;background:var(--surface2);border:1px solid var(--border);border-radius:8px;color:var(--text);font-family:var(--mono);font-size:12.5px;padding:14px 16px;resize:vertical;min-height:88px;line-height:1.75;transition:border-color .2s}
textarea:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-glow)}
textarea::placeholder{color:var(--text-dim);opacity:.45}
.hint{font-size:11.5px;color:var(--text-dim);margin-top:10px;line-height:1.55}
.method-row{display:flex;gap:16px;margin-top:16px;align-items:center;flex-wrap:wrap}
.method-row>span{font-size:11px;font-weight:600;color:var(--text-dim);text-transform:uppercase;letter-spacing:.8px}
.method-radio{display:flex;align-items:center;gap:6px;cursor:pointer;font-size:12.5px;color:var(--text)}
.method-radio input{accent-color:var(--accent)}
.proxy-input{background:var(--surface2);border:1px solid var(--border);border-radius:6px;color:var(--text);font-family:var(--mono);font-size:12px;padding:8px 12px;width:320px;transition:border-color .2s}
.proxy-input:focus{outline:none;border-color:var(--border-focus);box-shadow:0 0 0 3px var(--accent-glow)}
.btn{display:inline-flex;align-items:center;gap:8px;padding:11px 22px;border:none;border-radius:8px;font-family:var(--font);font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;white-space:nowrap}
.btn svg{width:15px;height:15px;flex-shrink:0}
.btn-primary{background:var(--accent);color:#fff;box-shadow:0 0 20px var(--accent-glow)}
.btn-primary:hover:not(:disabled){background:var(--accent-hover);transform:translateY(-1px);box-shadow:0 4px 24px rgba(59,130,246,.28)}
.btn-primary:disabled{opacity:.35;cursor:not-allowed;transform:none}
.btn-out{background:var(--surface2);color:var(--text);border:1px solid var(--border)}
.btn-out:hover:not(:disabled){background:var(--border);transform:translateY(-1px)}
.btn-out:disabled{opacity:.25;cursor:not-allowed;transform:none}
.status{display:none;align-items:center;gap:12px;padding:13px 20px;background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);margin-bottom:24px;font-size:13px}
.status.vis{display:flex}
.status.ld{border-color:var(--accent);background:var(--accent-glow)}
.status.ok{border-color:var(--green);background:var(--green-dim)}
.status.er{border-color:var(--red);background:var(--red-dim)}
.spin{width:17px;height:17px;border:2px solid var(--border);border-top-color:var(--accent);border-radius:50%;animation:sp .7s linear infinite}
.status .num{font-family:var(--mono);color:var(--accent);font-weight:500;margin-left:auto}
.toolbar{display:flex;align-items:center;justify-content:space-between;margin-bottom:14px}
.toolbar-l{font-size:13px;color:var(--text-dim)}
.toolbar-l strong{color:var(--text);font-family:var(--mono)}
.toolbar-r{display:flex;gap:10px}
.tw{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);overflow:hidden;animation:fadeU .45s ease}
.ts{overflow-x:auto;max-height:70vh;overflow-y:auto}
table{width:100%;border-collapse:collapse;font-size:13px}
thead th{background:var(--surface2);color:var(--text-dim);font-weight:600;font-size:11px;text-transform:uppercase;letter-spacing:.8px;padding:14px 18px;text-align:left;border-bottom:1px solid var(--border);position:sticky;top:0;z-index:2}
tbody tr{border-bottom:1px solid var(--border);transition:background .12s}
tbody tr:hover{background:rgba(59,130,246,.035)}
tbody tr:last-child{border-bottom:none}
td{padding:12px 18px;vertical-align:middle;line-height:1.5}
td.nc{font-weight:600;white-space:nowrap}
.badge{display:inline-block;padding:3px 10px;border-radius:20px;font-size:11px;font-weight:600;font-family:var(--mono)}
.b-com{background:var(--amber-dim);color:var(--amber);border:1px solid rgba(245,158,11,.18)}
.b-role{background:var(--green-dim);color:var(--green);border:1px solid rgba(34,197,94,.18)}
.b-role.none{color:var(--text-dim);background:transparent;border-color:var(--border)}
.empty{text-align:center;padding:72px 40px;color:var(--text-dim)}
.empty .ico{font-size:44px;margin-bottom:14px;opacity:.35}
.empty h3{font-size:15px;color:var(--text);margin-bottom:6px}
.empty p{font-size:12.5px}
.info-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:18px 22px;margin-bottom:20px;font-size:12.5px;color:var(--text-dim);line-height:1.7}
.info-box code{background:var(--surface2);padding:2px 6px;border-radius:4px;font-family:var(--mono);font-size:11.5px;color:var(--accent)}
.info-box strong{color:var(--text)}
.debug-box{background:var(--surface);border:1px solid var(--border);border-radius:var(--radius);padding:16px 20px;margin-top:20px;font-size:11.5px;font-family:var(--mono);color:var(--text-dim);line-height:1.7;max-height:300px;overflow-y:auto;white-space:pre-wrap;display:none}
.debug-box.vis{display:block}
@keyframes fadeD{from{opacity:0;transform:translateY(-10px)}to{opacity:1;transform:none}}
@keyframes fadeU{from{opacity:0;transform:translateY(10px)}to{opacity:1;transform:none}}
@keyframes sp{to{transform:rotate(360deg)}}
@keyframes rowIn{from{opacity:0;transform:translateX(-6px)}to{opacity:1;transform:none}}
tbody tr{animation:rowIn .25s ease backwards}
@media(max-width:700px){.app{padding:16px}.input-row{flex-direction:column}.toolbar{flex-direction:column;gap:10px;align-items:flex-start}.method-row{flex-direction:column;gap:8px}}
</style>
</head>
<body>
<div class="app">
  <div class="header">
    <div class="header-icon">ğŸ›</div>
    <div>
      <h1>CDEP <span>Scraper</span></h1>
      <p>Extragere date parlamentari â€” Camera DeputaÈ›ilor</p>
    </div>
  </div>
  <div class="info-box">
    <strong>âš  Site-ul cdep.ro blocheazÄƒ accesul direct din browser (CORS).</strong> AlegeÈ›i o metodÄƒ:<br>
    <strong>â‘  Proxy local (recomandat):</strong> <code>npx cors-anywhere</code> Ã®n terminal â†’ <code>http://localhost:8080</code><br>
    <strong>â‘¡ Extensie CORS:</strong> Extensia <strong>"Allow CORS"</strong> / <strong>"CORS Unblock"</strong> activatÄƒ Ã®n browser.<br>
    <strong>â‘¢ Proxy public:</strong> FÄƒrÄƒ instalare, dar poate fi lent/indisponibil.
  </div>
  <div class="panel">
    <label>Link-uri pagini parlamentari (cÃ¢te un link pe linie)</label>
    <div class="input-row">
      <textarea id="inp" placeholder="https://www.cdep.ro/pls/parlam/structura2015.mp?idm=294&cam=2&leg=2020&idl=1
https://www.cdep.ro/pls/parlam/structura2015.mp?idm=204&cam=2&leg=2020
..."></textarea>
      <button class="btn btn-primary" id="btnGo" onclick="run()">
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M21 12a9 9 0 11-18 0 9 9 0 0118 0z"/><path d="M9 12l2 2 4-4"/></svg>
        Extrage
      </button>
    </div>
    <div class="method-row">
      <span>MetodÄƒ acces:</span>
      <label class="method-radio"><input type="radio" name="method" value="proxy" checked onchange="toggleProxy()"> Proxy local</label>
      <label class="method-radio"><input type="radio" name="method" value="direct" onchange="toggleProxy()"> Direct (extensie CORS)</label>
      <label class="method-radio"><input type="radio" name="method" value="public" onchange="toggleProxy()"> Proxy public</label>
    </div>
    <div id="proxyRow" style="margin-top:12px">
      <input class="proxy-input" id="proxyUrl" value="http://localhost:8080/" placeholder="http://localhost:8080/">
      <span style="font-size:11px;color:var(--text-dim);margin-left:8px">URL proxy local</span>
    </div>
    <p class="hint">Se selecteazÄƒ comisia cu <strong>cea mai recentÄƒ datÄƒ de aderare</strong> <code>(din luna anul)</code>. Comisiile Ã®ncheiate <code>(pÃ¢nÄƒ Ã®n ...)</code> sunt ignorate dacÄƒ existÄƒ comisii active.</p>
  </div>
  <div class="status" id="st">
    <div class="spin" id="stSpin"></div>
    <span id="stTxt"></span>
    <span class="num" id="stNum"></span>
  </div>
  <div class="toolbar">
    <div class="toolbar-l" id="cnt"></div>
    <div class="toolbar-r">
      <button class="btn btn-out" id="bCSV" onclick="expCSV()" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Export CSV
      </button>
      <button class="btn btn-out" id="bXL" onclick="expXL()" disabled>
        <svg viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2"><path d="M14 2H6a2 2 0 00-2 2v16a2 2 0 002 2h12a2 2 0 002-2V8z"/><polyline points="14 2 14 8 20 8"/><line x1="16" y1="13" x2="8" y2="13"/><line x1="16" y1="17" x2="8" y2="17"/></svg>
        Export Excel
      </button>
    </div>
  </div>
  <div id="out">
    <div class="empty"><div class="ico">ğŸ“‹</div><h3>Niciun rezultat</h3><p>IntroduceÈ›i link-uri È™i apÄƒsaÈ›i â€Extrage" pentru a Ã®ncepe.</p></div>
  </div>
  <div class="debug-box" id="dbg"></div>
</div>

<script>
/* â•â•â• MAPPINGS â•â•â• */
const COM_KW={
  0:["agricultura","silvicultur"],1:["buget","finant","financ","banci","bÄƒnci"],
  2:["cultura","arta","artÄƒ","informational"],3:["aparar","apÄƒrar","ordine publica","ordine publicÄƒ","sigurant","siguranÈ›"],
  4:["economi","reforma","reform","privatiz","antreprenoriat"],5:["educati","educaÈ›","stiint","È™tiinÈ›","tineret","sport"],
  6:["externe","afaceri externe"],7:["sanat","sÄƒnÄƒtat","familie"],
  8:["drepturile omului","culte","minorit"],9:["industri","servicii"],
  10:["justiti","justiÈ›i","contestat"],11:["ordine de drept","ordinii de drept"],
  12:["administratie","administraÈ›i","mediu"],13:["munca","muncÄƒ","muncii","protecti","protecÈ›i","sociala","socialÄƒ"],
  14:["integrar","european"],16:["abuz","corupti","corupÈ›i","petiti","petiÈ›i"],
  17:["egalitat","sanse","È™anse"],18:["tehnologi","informati","comunicati"],
  19:["regulament"],20:["juridic","disciplin","imunitat"],21:["regulamente"],
  22:["centenar"],23:["spatiu","spaÈ›iu","subcomisi"],24:["revizuir","constitut"],
  25:["revoluti","revoluÈ›i","1989"],26:["transport","energi","infrastructur"],
  27:["diaspora"],28:["SIE","controlul activit"],
};
const COM_NAME={0:"AgriculturÄƒ",1:"Buget/FinanÈ›e",2:"CulturÄƒ",3:"ApÄƒrare",4:"Economie",5:"EducaÈ›ie",6:"Afaceri externe",7:"SÄƒnÄƒtate",8:"Drepturile omului",9:"Industrie",10:"JustiÈ›ie",11:"Ordine de drept",12:"Admin. publicÄƒ",13:"MuncÄƒ",14:"Integrare EU",15:"FÄƒrÄƒ comisie",16:"Abuzuri/CorupÈ›ie",17:"Egalitate È™anse",18:"IT&C",19:"Regulament",20:"JuridicÄƒ",21:"Regulamente",22:"Centenar",23:"SpaÈ›iu",24:"Revizuire Const.",25:"RevoluÈ›ia 1989",26:"Transport/Energie",27:"Diaspora",28:"Control SIE",99:"FÄƒrÄƒ date"};
const ROLE_NAME={0:"FÄƒrÄƒ funcÈ›ie",1:"PreÈ™edinte",2:"VicepreÈ™edinte",3:"Secretar"};

/* â•â•â• MONTH PARSER â•â•â• */
const MO={"ian":1,"ianuarie":1,"feb":2,"februarie":2,"mar":3,"martie":3,"apr":4,"aprilie":4,"mai":5,"iun":6,"iunie":6,"iul":7,"iulie":7,"aug":8,"august":8,"sep":9,"sept":9,"septembrie":9,"oct":10,"octombrie":10,"nov":11,"noiembrie":11,"dec":12,"decembrie":12};

function parseRoDate(str){
  if(!str)return 0;
  const s=str.toLowerCase().replace(/\./g,"").trim();
  const m=s.match(/([a-zÄƒÃ¢Ã®È™È›]+)\s*(\d{4})/);
  if(!m)return 0;
  const mon=MO[m[1]],yr=parseInt(m[2]);
  return(mon&&yr)?yr*100+mon:0;
}

let results=[], debugLog=[];

/* â•â•â• NETWORK â•â•â• */
function toggleProxy(){
  document.getElementById("proxyRow").style.display=
    document.querySelector('input[name="method"]:checked').value==="proxy"?"block":"none";
}
const PUB_PX=[
  u=>`https://api.allorigins.win/raw?url=${encodeURIComponent(u)}`,
  u=>`https://corsproxy.io/?${encodeURIComponent(u)}`,
  u=>`https://api.codetabs.com/v1/proxy?quest=${encodeURIComponent(u)}`,
];
async function grab(url){
  const method=document.querySelector('input[name="method"]:checked').value;
  if(method==="direct"){
    const r=await fetch(url,{signal:AbortSignal.timeout(25000)});
    if(!r.ok)throw new Error(`HTTP ${r.status}`);return await r.text();
  }
  if(method==="proxy"){
    let base=document.getElementById("proxyUrl").value.trim();
    if(!base.endsWith("/"))base+="/";
    const r=await fetch(base+url,{signal:AbortSignal.timeout(25000)});
    if(!r.ok)throw new Error(`Proxy â†’ HTTP ${r.status}`);return await r.text();
  }
  for(const pf of PUB_PX){
    try{const r=await fetch(pf(url),{signal:AbortSignal.timeout(20000)});
      if(r.ok){const t=await r.text();if(t.length>200)return t;}}catch(e){}
  }
  throw new Error("Proxy-urile publice au eÈ™uat");
}

/* â•â•â• PARSING â•â•â• */
function parseDoc(h){return new DOMParser().parseFromString(h,"text/html")}

function getName(doc){
  const title=doc.querySelector("title");
  if(title){const t=title.textContent.trim();if(t.length>3&&t.length<60&&!/(camera|cdep|parlament|legislat)/i.test(t))return t;}
  for(const tag of["h1","h2","h3"]){for(const el of doc.querySelectorAll(tag)){const t=el.textContent.trim();if(t.length>4&&t.length<80&&!/(camera|comisi|parlament|structur|legislat)/i.test(t))return t;}}
  for(const b of doc.querySelectorAll("b,strong")){const t=b.textContent.trim();if(t.length>4&&t.length<60&&/^[A-ZÄ‚Ã‚ÃÈ˜Èš]/.test(t))return t;}
  return "Necunoscut";
}

function idCom(text){
  const low=text.toLowerCase();let best=null,bestN=0;
  for(const[code,kws]of Object.entries(COM_KW)){
    const n=kws.filter(k=>low.includes(k.toLowerCase())).length;
    if(n>bestN){bestN=n;best=parseInt(code);}
  }
  return best;
}

/*
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 * CORE: Parse committees from actual HTML structure
 * â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
 *
 * cdep.ro HTML structure (real):
 *
 *   <a href="...structura2015.co?idc=1&...">Comisia pentru politicÄƒ economicÄƒ...</a>
 *   (din  feb. 2023)
 *   <br>
 *   <a href="...structura2015.co?idc=34&...">Comisia pentru transporturi...</a>
 *   (din  iun. 2023)
 *   <br>
 *   <a href="...structura2015.co?idc=34&...">Comisia pentru transporturi...</a>
 *   (pÃ¢nÄƒ Ã®n  feb. 2021)
 *
 * And for roles:
 *   <a href="...">Comisia X</a> (din feb. 2021)
 *   - PreÈ™edinte (feb. 2021 - sep. 2023), Secretar (din sep. 2023)
 *
 * Strategy:
 *   1. Find all <a> with href containing "structura2015.co"
 *   2. For each <a>, get the committee name from link text
 *   3. Get the text AFTER the </a> up to the next <a> or <br>
 *      â†’ this contains "(din feb. 2023)" and optional "- PreÈ™edinte ..."
 *   4. Parse date and role from that trailing text
 *   5. Filter: only "din" entries (active), ignore "pÃ¢nÄƒ Ã®n" (ended)
 *   6. Pick the one with the most recent "din" date
 */
function getCommittee(doc, mpName){
  const log = [];
  const entries = [];

  // Find all committee links
  const links = doc.querySelectorAll('a[href*="structura2015.co"]');

  if(links.length > 0){
    log.push(`  GÄƒsite ${links.length} link-uri de comisii Ã®n HTML`);

    for(const a of links){
      const comName = a.textContent.trim();
      const code = idCom(comName);
      if(code === null){
        log.push(`  âŠ˜ Skip (cod necunoscut): "${comName}"`);
        continue;
      }

      // Get ALL text after this <a> until the next <a> or block boundary
      // Walk sibling nodes after this <a>
      let trailingText = "";
      let node = a.nextSibling;
      while(node){
        if(node.nodeType === Node.TEXT_NODE){
          trailingText += node.textContent;
        } else if(node.nodeType === Node.ELEMENT_NODE){
          // Stop at next <a> link (next committee) or <br> separators
          if(node.tagName === "A") break;
          // But include text from inline elements like <br>
          if(node.tagName === "BR"){
            // Check if next meaningful content is another <a>
            // (br is just a separator, keep scanning)
            // but do break the trailing text here
            break;
          }
          trailingText += node.textContent;
        }
        node = node.nextSibling;
      }

      trailingText = trailingText.trim();

      // Parse date from trailing text
      // Patterns:
      //   "(din  feb. 2023)"           â†’ active, joinDate=202302
      //   "(din  iun. 2023)"           â†’ active, joinDate=202306
      //   "(pÃ¢nÄƒ Ã®n  feb. 2021)"       â†’ ended, joinDate=0
      //   "(feb. 2021 - apr. 2022)"    â†’ ended, joinDate from start
      let joinDate = 0;
      let isActive = false;

      // Check for "(din ...)"
      const dinMatch = trailingText.match(/\(\s*din\s+([^)]+)\)/i);
      if(dinMatch){
        joinDate = parseRoDate(dinMatch[1]);
        isActive = true;
      }

      // Check for "(pÃ¢nÄƒ Ã®n ...)" â†’ ended
      const panaMatch = trailingText.match(/\(\s*pÃ¢n[aÄƒ]\s+[iÃ®]n\s+([^)]+)\)/i);
      if(panaMatch){
        isActive = false;
        joinDate = 0; // no clear start date
      }

      // Check for "(month year - month year)" â†’ range, ended
      const rangeMatch = trailingText.match(/\(\s*([a-zÄƒÃ¢Ã®È™È›]+\.?\s*\d{4})\s*-\s*([a-zÄƒÃ¢Ã®È™È›]+\.?\s*\d{4})\s*\)/i);
      if(rangeMatch && !dinMatch){
        joinDate = parseRoDate(rangeMatch[1]);
        isActive = false;
      }

      // Parse role from trailing text
      // Pattern: "- PreÈ™edinte (...), Secretar (...), PreÈ™edinte (din ...)"
      // Take the LAST role mentioned (current one)
      let role = 0;
      const roleText = trailingText.toLowerCase();
      // Split by comma to find individual role segments
      const roleSegments = roleText.split(/,/);
      for(const seg of roleSegments){
        if(/pre[sÅŸ]edinte/i.test(seg) && !/vicepre[sÅŸ]edinte/i.test(seg)) role = 1;
        else if(/vicepre[sÅŸ]edinte/i.test(seg)) role = 2;
        else if(/secretar/i.test(seg)) role = 3;
      }

      const entry = {
        code, role, joinDate, isActive,
        name: comName.substring(0, 70),
        raw: trailingText.substring(0, 80)
      };
      entries.push(entry);

      log.push(`  ${isActive ? "âœ… ACTIV" : "â›” ÃNCHEIAT"}  cod=${code} (${COM_NAME[code]})  data=${joinDate}  rol=${role}  "${comName.substring(0,50)}..." â†’ "${trailingText.substring(0,50)}"`);
    }
  }

  // Fallback: text-based parsing if no links found
  if(entries.length === 0){
    log.push("  âš  Niciun link structura2015.co gÄƒsit, se foloseÈ™te fallback text");
    const fullText = doc.body?.textContent || "";
    const comRegex = /Comisia\s+(?:pentru\s+|de\s+|privind\s+)?[^\n]{5,}/gi;
    for(const m of [...fullText.matchAll(comRegex)]){
      const block = m[0];
      const code = idCom(block);
      if(code === null) continue;
      const dinM = block.match(/\(\s*din\s+([^)]+)\)/i);
      const joinDate = dinM ? parseRoDate(dinM[1]) : 0;
      const isActive = !!dinM;
      let role = 0;
      const segs = block.toLowerCase().split(/,/);
      for(const seg of segs){
        if(/pre[sÅŸ]edinte/i.test(seg) && !/vicepre[sÅŸ]edinte/i.test(seg)) role = 1;
        else if(/vicepre[sÅŸ]edinte/i.test(seg)) role = 2;
        else if(/secretar/i.test(seg)) role = 3;
      }
      entries.push({code, role, joinDate, isActive, name: block.substring(0,70), raw: ""});
      log.push(`  [fallback] cod=${code} data=${joinDate} rol=${role} activ=${isActive}`);
    }
  }

  debugLog.push(`\nâ–¸ ${mpName}: ${entries.length} comisii`);
  log.forEach(l => debugLog.push(l));

  if(!entries.length){
    debugLog.push("  â†’ REZULTAT: 99 (fÄƒrÄƒ date)");
    return {comisie: 99, functie: 0};
  }

  // â”€â”€ SELECTION LOGIC â”€â”€
  // Step 1: prefer ACTIVE committees (those with "din ...")
  let candidates = entries.filter(e => e.isActive);
  if(!candidates.length) candidates = entries;

  // Step 2: sort by joinDate DESCENDING (most recent first)
  candidates.sort((a, b) => b.joinDate - a.joinDate);

  const winner = candidates[0];
  debugLog.push(`  â†’ SELECTAT: cod=${winner.code} (${COM_NAME[winner.code]}) data=${winner.joinDate} rol=${winner.role} "${winner.name}"`);

  return {comisie: winner.code, functie: winner.role};
}

async function processURL(url){
  const html = await grab(url);
  const doc = parseDoc(html);
  const name = getName(doc);
  const {comisie, functie} = getCommittee(doc, name);
  return {
    nume: name, comisie,
    comisie_label: COM_NAME[comisie] || "FÄƒrÄƒ date",
    functie,
    functie_label: ROLE_NAME[functie] || "FÄƒrÄƒ funcÈ›ie",
    url,
  };
}

/* â•â•â• MAIN â•â•â• */
async function run(){
  const raw = document.getElementById("inp").value.trim();
  if(!raw) return;
  const urls = raw.split(/\n/).map(l => l.trim()).filter(l => l.startsWith("http"));
  if(!urls.length){setSt("er","Nu s-au gÄƒsit link-uri valide.");return;}

  document.getElementById("btnGo").disabled = true;
  results = []; debugLog = ["â•â•â• LOG PROCESARE â•â•â•"];
  setSt("ld","Se proceseazÄƒ...",`0 / ${urls.length}`);

  for(let i = 0; i < urls.length; i++){
    try{
      updSt(`${urls[i].substring(0,60)}...`, `${i+1} / ${urls.length}`);
      results.push(await processURL(urls[i]));
    }catch(e){
      results.push({nume:"âŒ Eroare",comisie:99,comisie_label:e.message.substring(0,50),functie:0,functie_label:"â€”",url:urls[i]});
      debugLog.push(`\nâ–¸ EROARE ${urls[i]}: ${e.message}`);
    }
    render(results);
    if(i < urls.length - 1) await new Promise(r => setTimeout(r, 600));
  }

  setSt("ok",`Finalizat! ${results.length} parlamentari procesaÈ›i.`);
  document.getElementById("bCSV").disabled = false;
  document.getElementById("bXL").disabled = false;
  document.getElementById("btnGo").disabled = false;
  const dbg = document.getElementById("dbg");
  dbg.textContent = debugLog.join("\n");
  dbg.classList.add("vis");
}

/* â•â•â• RENDER â•â•â• */
function render(data){
  document.getElementById("cnt").innerHTML = `<strong>${data.length}</strong> rezultate`;
  if(!data.length){document.getElementById("out").innerHTML=`<div class="empty"><div class="ico">ğŸ“‹</div><h3>Niciun rezultat</h3><p>IntroduceÈ›i link-uri È™i apÄƒsaÈ›i â€Extrage".</p></div>`;return;}
  let h=`<div class="tw"><div class="ts"><table><thead><tr><th style="width:40%">Nume</th><th style="width:36%">Comisie</th><th style="width:24%">FuncÈ›ie</th></tr></thead><tbody>`;
  for(const r of data){
    const rc = r.functie === 0 ? "b-role none" : "b-role";
    h += `<tr><td class="nc">${esc(r.nume)}</td><td><span class="badge b-com">${r.comisie} â€” ${esc(r.comisie_label)}</span></td><td><span class="badge ${rc}">${r.functie} â€” ${esc(r.functie_label)}</span></td></tr>`;
  }
  h += `</tbody></table></div></div>`;
  document.getElementById("out").innerHTML = h;
}

/* â•â•â• EXPORT â•â•â• */
function expCSV(){
  if(!results.length) return;
  const rows = results.map(r => [r.nume, r.comisie, r.functie].map(v => `"${String(v).replace(/"/g,'""')}"`).join(","));
  dl("\uFEFF" + "Nume,Comisie,FuncÈ›ie\n" + rows.join("\n"), "parlamentari.csv", "text/csv;charset=utf-8;");
}
function expXL(){
  if(!results.length) return;
  const ws = XLSX.utils.aoa_to_sheet([["Nume","Comisie","FuncÈ›ie"], ...results.map(r => [r.nume, r.comisie, r.functie])]);
  ws['!cols'] = [{wch:35},{wch:12},{wch:12}];
  const wb = XLSX.utils.book_new(); XLSX.utils.book_append_sheet(wb, ws, "Parlamentari");
  XLSX.writeFile(wb, "parlamentari.xlsx");
}

/* â•â•â• UTILS â•â•â• */
function esc(s){const d=document.createElement("div");d.textContent=String(s);return d.innerHTML}
function dl(c,f,t){const b=new Blob([c],{type:t}),a=document.createElement("a");a.href=URL.createObjectURL(b);a.download=f;a.click();URL.revokeObjectURL(a.href)}
function setSt(type,txt,num){const b=document.getElementById("st");b.className=`status vis ${type}`;document.getElementById("stTxt").textContent=txt;document.getElementById("stNum").textContent=num||"";document.getElementById("stSpin").style.display=type==="ld"?"block":"none"}
function updSt(txt,num){document.getElementById("stTxt").textContent=txt;document.getElementById("stNum").textContent=num||""}
</script>
</body>
</html>
